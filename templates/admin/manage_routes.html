{% extends 'components/base.html' %}
{% block title %}Manage Routes | Go Sewa{% endblock %}
{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="row g-0">
        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3 rounded-3 shadow-sm" role="alert">
                        <i class="bi bi-info-circle me-2"></i>{{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 fw-bold text-dark">
                    <i class="bi bi-signpost-split-fill me-2 text-primary"></i>Manage Routes
                </h1>
                <div class="d-flex gap-2">
                    <button id="addRouteBtn" class="btn btn-primary shadow-sm rounded-3 d-none d-md-block">
                        <i class="bi bi-plus-circle-fill me-2"></i>Add Route
                    </button>
                    <button id="mobileAddRouteBtn" class="btn btn-primary shadow-sm rounded-3 d-md-none">
                        <i class="bi bi-plus-circle-fill"></i>
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="mb-4">
                <div class="input-group shadow-sm rounded-3" style="max-width: 400px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0" id="searchRoutes" placeholder="Search routes by source, destination, or sub-route..." aria-label="Search routes">
                </div>
            </div>

            <!-- Routes Grid -->
            <div class="row g-3" id="routesGrid">
                {% for route in routes %}
                <div class="col-12 col-md-6 col-lg-4 route-card">
                    <div class="card border-0 shadow-sm rounded-3 h-100">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center mb-3">
                                {% if route.image %}
                                    <img src="{{ route.image.url }}" alt="Route Image" class="rounded-2 me-3" style="width: 80px; height: 60px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-2 bg-light text-muted d-flex align-items-center justify-content-center me-3" style="width: 80px; height: 60px;">
                                        <i class="bi bi-image fs-4"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <h5 class="mb-1 fw-bold">
                                        <a href="{% url 'route_bus_list' route.id %}" class="text-decoration-none text-primary">{{ route.source }} to {{ route.destination }}</a>
                                    </h5>
                                    <p class="mb-0 text-muted small">{{ route.distance }} km | {{ route.estimated_time }} hr</p>
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong class="text-muted small">Sub-Routes:</strong>
                                {% if route.sub_routes.all %}
                                    <div class="d-flex flex-wrap gap-1 mt-1">
                                        {% for sub_route in route.sub_routes.all %}
                                            <span class="badge bg-primary-subtle text-primary border border-primary rounded-pill">{{ sub_route.name }}</span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted small">None</span>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <strong class="text-muted small">Description:</strong>
                                <p class="text-muted">{{ route.description|default:"No description provided." }}</p>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <a href="{% url 'route_bus_list' route.id %}" class="btn btn-outline-primary btn-sm shadow-sm" title="View Buses">
                                    <i class="bi bi-bus-front-fill"></i>
                                </a>
                                {% if user.role == "admin" %}
                                <a href="{% url 'edit_route' route.id %}" class="btn btn-outline-warning btn-sm shadow-sm" title="Edit Route">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <button class="btn btn-outline-danger btn-sm shadow-sm delete-route-btn" 
                                        data-route-id="{{ route.id }}"
                                        data-route-source="{{ route.source }}"
                                        data-route-destination="{{ route.destination }}"
                                        title="Delete Route">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <div class="py-4">
                        <i class="bi bi-signpost-split-fill display-4 text-muted mb-3"></i>
                        <h4 class="text-muted fw-semibold">No Routes Found</h4>
                        <p class="text-muted mb-4">Get started by adding your first route.</p>
                        <button id="emptyAddRouteBtn" class="btn btn-primary shadow-sm rounded-3">
                            <i class="bi bi-plus-circle-fill me-2"></i>Add Route
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if routes.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if routes.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ routes.previous_page_number }}" aria-label="Previous">
                            <span aria-hidden="true">«</span>
                        </a>
                    </li>
                    {% endif %}
                    {% for num in routes.paginator.page_range %}
                    <li class="page-item {% if routes.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endfor %}
                    {% if routes.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ routes.next_page_number }}" aria-label="Next">
                            <span aria-hidden="true">»</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </main>
    </div>
</div>

<!-- Add Route Modal -->
<div class="modal fade" id="addRouteModal" tabindex="-1" aria-labelledby="addRouteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content rounded-3 shadow-lg">
            <div class="modal-header border-bottom-0 bg-light">
                <h5 class="modal-title fw-bold" id="addRouteModalLabel">
                    <i class="bi bi-signpost-split-fill me-2 text-primary"></i>Add New Route
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST" enctype="multipart/form-data" id="addRouteForm" novalidate>
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="source" class="form-label fw-medium">Source <span class="text-danger">*</span></label>
                            <input type="text" class="form-control rounded-3" id="source" name="source" placeholder="e.g., Kathmandu" required>
                            <div class="invalid-feedback">Please enter the source location.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="destination" class="form-label fw-medium">Destination <span class="text-danger">*</span></label>
                            <input type="text" class="form-control rounded-3" id="destination" name="destination" placeholder="e.g., Pokhara" required>
                            <div class="invalid-feedback">Please enter the destination location.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="distance" class="form-label fw-medium">Distance (km) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-rulers"></i></span>
                                <input type="number" step="0.01" class="form-control rounded-end" id="distance" name="distance" placeholder="e.g., 200" min="0.01" required>
                            </div>
                            <div class="invalid-feedback">Please enter a valid distance.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="estimated_time" class="form-label fw-medium">Estimated Time (hr) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-clock"></i></span>
                                <input type="number" step="0.1" class="form-control rounded-end" id="estimated_time" name="estimated_time" placeholder="e.g., 6.5" min="0.1" required>
                            </div>
                            <div class="invalid-feedback">Please enter a valid estimated time.</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-medium">Sub-Routes (max 5)</label>
                            <div class="border rounded-3 p-3 bg-light">
                                <ul class="list-group list-group-flush mb-3" id="subRoutesList"></ul>
                                <small class="text-muted d-block mb-2">Add new sub-routes below.</small>
                                <div class="input-group">
                                    <input type="text" class="form-control rounded-start" id="new_sub_route" placeholder="e.g., Bhaktapur" aria-label="New sub-route">
                                    <button type="button" class="btn btn-outline-primary rounded-end" id="addSubRouteBtn">
                                        <i class="bi bi-plus-circle me-1"></i>Add Sub-Route
                                    </button>
                                </div>
                                <small class="text-muted mt-1">Enter a new sub-route name and click "Add Sub-Route"</small>
                                <div id="subRouteError" class="invalid-feedback d-none mt-1"></div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="image" class="form-label fw-medium">Route Image</label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-image"></i></span>
                                <input type="file" class="form-control rounded-end" id="image" name="image" accept="image/*">
                            </div>
                            <small class="text-muted">Optional: Upload an image representing the route</small>
                        </div>

                        <div class="col-12">
                            <label for="description" class="form-label fw-medium">Description</label>
                            <textarea class="form-control rounded-3" id="description" name="description" rows="3" placeholder="Optional: Add a brief description of the route"></textarea>
                        
                    </div>
                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-outline-secondary rounded-3 me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary rounded-3">
                            <i class="bi bi-plus-circle-fill me-1"></i>Add Route
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteRouteModal" tabindex="-1" aria-labelledby="deleteRouteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-3 shadow-sm">
            <div class="modal-header border-bottom-0 bg-light">
                <h5 class="modal-title fw-bold" id="deleteRouteModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-1 text-danger"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Delete route <strong id="routeName"></strong>?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-outline-secondary btn-sm rounded-3" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteRouteForm" action="#">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm rounded-3">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Bootstrap modals
    const addRouteModal = new bootstrap.Modal(document.getElementById('addRouteModal'));
    const deleteRouteModal = new bootstrap.Modal(document.getElementById('deleteRouteModal'));

    // Show Add Route Modal
    const addButtons = [
        document.getElementById('addRouteBtn'),
        document.getElementById('mobileAddRouteBtn'),
        document.getElementById('emptyAddRouteBtn')
    ];
    
    addButtons.forEach(button => {
        if (button) {
            button.addEventListener('click', () => {
                addRouteModal.show();
            });
        }
    });

    // Delete confirmation
    document.querySelectorAll('.delete-route-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const routeId = button.getAttribute('data-route-id');
            const source = button.getAttribute('data-route-source');
            const destination = button.getAttribute('data-route-destination');
            const routeName = `${source} to ${destination}`;
            
            document.getElementById('routeName').textContent = routeName;
            document.getElementById('deleteRouteForm').action = `/routes-delete/${routeId}/`;
            
            deleteRouteModal.show();
        });
    });

    // Search functionality
    const searchInput = document.getElementById('searchRoutes');
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const routeCards = document.querySelectorAll('.route-card');
            routeCards.forEach(card => {
                const source = card.querySelector('.text-primary').textContent.toLowerCase();
                const destination = source.split(' to ')[1] || '';
                const subRoutes = Array.from(card.querySelectorAll('.badge'))
                    .map(badge => badge.textContent.toLowerCase())
                    .join(' ');
                const isVisible = source.includes(searchTerm) || destination.includes(searchTerm) || subRoutes.includes(searchTerm);
                card.style.display = isVisible ? '' : 'none';
            });
        });
    }

    // Add Route Form: Sub-Route Handling
    const addRouteForm = document.getElementById('addRouteForm');
    const subRoutesList = document.getElementById('subRoutesList');
    const newSubRouteInput = document.getElementById('new_sub_route');
    const addSubRouteBtn = document.getElementById('addSubRouteBtn');
    const subRouteError = document.getElementById('subRouteError');

    // Hidden input for sub-routes
    const subRoutesInput = document.createElement('input');
    subRoutesInput.type = 'hidden';
    subRoutesInput.name = 'sub_routes';
    addRouteForm.appendChild(subRoutesInput);

    // Update hidden input
    const updateSubRoutesInput = () => {
        const subRoutes = [];
        subRoutesList.querySelectorAll('li').forEach(li => {
            const input = li.querySelector('.sub-route-input');
            const value = input.value.trim();
            if (value) {
                subRoutes.push(`${value}`);
            }
        });
        subRoutesInput.value = subRoutes.join(',');
    };

    // Add new sub-route
    if (addSubRouteBtn) {
        addSubRouteBtn.addEventListener('click', () => {
            const newSubRouteName = newSubRouteInput.value.trim();
            if (!newSubRouteName) {
                newSubRouteInput.classList.add('is-invalid');
                subRouteError.classList.remove('d-none');
                subRouteError.textContent = 'Please enter a sub-route name.';
                return;
            }

            // Check for duplicates
            const existingNames = Array.from(subRoutesList.querySelectorAll('.sub-route-input'))
                .map(input => input.value.toLowerCase());
            if (existingNames.includes(newSubRouteName.toLowerCase())) {
                newSubRouteInput.classList.add('is-invalid');
                subRouteError.classList.remove('d-none');
                subRouteError.textContent = 'This sub-route already exists.';
                return;
            }

            // Check sub-routes limit
            if (subRoutesList.children.length >= 5) {
                subRouteError.classList.remove('d-none');
                subRouteError.textContent = 'Maximum 5 sub-routes allowed.';
                return;
            }

            // Add new sub-route to list
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center py-1';
            li.innerHTML = `
                <input type="text" class="form-control rounded-3 sub-route-input" value="${newSubRouteName}" readonly>
                <button type="button" class="btn btn-sm btn-outline-danger remove-sub-route ms-2" title="Remove">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            subRoutesList.appendChild(li);
            newSubRouteInput.value = '';
            newSubRouteInput.classList.remove('is-invalid');
            subRouteError.classList.add('d-none');
            updateSubRoutesInput();
        });
    }

    // Clear invalid state on input
    if (newSubRouteInput) {
        newSubRouteInput.addEventListener('input', () => {
            newSubRouteInput.classList.remove('is-invalid');
            subRouteError.classList.add('d-none');
            subRouteError.textContent = '';
        });
    }

    // Remove sub-route
    if (subRoutesList) {
        subRoutesList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-sub-route')) {
                e.target.closest('li').remove();
                subRouteError.classList.add('d-none');
                updateSubRoutesInput();
            }
        });
    }

    // Form validation
    if (addRouteForm) {
        addRouteForm.addEventListener('submit', (event) => {
            if (!addRouteForm.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            addRouteForm.classList.add('was-validated');
            addRouteForm.classList.add('was-validated-form');
            updateSubRoutesInput();
        });
    }
});
</script>
{% endblock %}