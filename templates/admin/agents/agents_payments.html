{% extends 'components/base.html' %}

{% block title %}Agent Payments & Commissions | Go Sewa{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Main Content -->
    <main class="dashboard-content px-3 px-md-4 py-4">
        <div class="container-fluid">
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Header -->
            <div class="d-flex justify-content-between flex-wrap align-items-center mb-4 pb-2 border-bottom">
                <h1 class="h3 fw-bold text-primary mb-3 mb-md-0">
                    <i class="bi bi-credit-card-2-front me-2"></i>Agent Payments & Commissions
                </h1>
            </div>

            <!-- Summary Cards (Total Earnings, Total Commission, Total Net) -->
            <div class="row g-3 mb-4">
                <!-- Total Earnings -->
                <div class="col-md-4 col-sm-6">
                    <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted fw-normal mb-2">Total Earnings</h6>
                                    <h3 class="mb-0 fw-bold text-success">NRP {{ total_earnings|floatformat:2 }}</h3>
                                </div>
                                <div class="icon-circle bg-success-soft rounded-circle p-3">
                                    <i class="bi bi-currency-exchange fs-4 text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Commission -->
                <div class="col-md-4 col-sm-6">
                    <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted fw-normal mb-2">Total Commission</h6>
                                    <h3 class="mb-0 fw-bold text-indigo">NRP {{ total_commission|floatformat:2 }}</h3>
                                </div>
                                <div class="icon-circle bg-indigo-soft rounded-circle p-3">
                                    <i class="bi bi-percent fs-4 text-indigo"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Net Amount -->
                <div class="col-md-4 col-sm-6">
                    <div class="card h-100 border-0 shadow-sm hover-shadow transition-all">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted fw-normal mb-2">Net Amount</h6>
                                    <h3 class="mb-0 fw-bold text-primary">NRP {{ total_net|floatformat:2 }}</h3>
                                </div>
                                <div class="icon-circle bg-primary-soft rounded-circle p-3">
                                    <i class="bi bi-wallet2 fs-4 text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Earnings Table -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center flex-wrap">
                    <h5 class="card-title mb-0">Each Agent Earnings Summary</h5>
                    <div class="d-flex mt-2 mt-md-0">
                        <input type="text" class="form-control form-control-sm me-2" id="agentSearch" placeholder="Search agents...">
                        <button class="btn btn-sm btn-outline-primary" id="exportBtn">
                            <i class="bi bi-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="agentEarningsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Agent Name</th>
                                    <th>Phone</th>
                                    <th>Commission Rate</th>
                                    <th>Total Earnings</th>
                                    <th>Commission</th>
                                    <th>Net Amount</th>
                                    <th>Total Bookings</th>
                                    <th>Total Companies</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for agent in agents_data %}
                                <tr class="agent-row">
                                    <td>{{ agent.agent_name }}</td>
                                    <td>{{ agent.agent_phone }}</td>
                                    <td>{{ agent.commission_rate }}%</td>
                                    <td>NRP {{ agent.total_earnings|floatformat:2 }}</td>
                                    <td>NRP {{ agent.commission_amount|floatformat:2 }}</td>
                                    <td>NRP {{ agent.net_amount|floatformat:2 }}</td>
                                    <td>{{ agent.total_bookings }}</td>
                                    <td>{{ agent.total_companies }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-4">No agent earnings found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Responsive sidebar */
    @media (min-width: 768px) {
        .dashboard-content {
            margin-left: 220px;
            transition: margin-left 0.3s ease;
        }
    }
    
    @media (max-width: 767.98px) {
        .dashboard-content {
            margin-left: 0;
        }
        
        .sidebar {
            width: 100%;
            position: relative;
            height: auto;
        }
    }
    
    /* Transitions and hover effects */
    .hover-shadow {
        transition: all 0.3s ease;
    }
    
    .hover-shadow:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    .icon-circle {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Color utilities */
    .bg-success-soft {
        background-color: rgba(40, 167, 69, 0.1);
    }
    .bg-primary-soft {
        background-color: rgba(0, 123, 255, 0.1);
    }
    .bg-indigo-soft {
        background-color: rgba(102, 16, 242, 0.1);
    }
    .text-indigo {
        color: #6610f2;
    }
    
    /* Table responsiveness */
    .table-responsive {
        overflow-x: auto;
    }
    
    .table th, .table td {
        vertical-align: middle;
        white-space: nowrap;
    }
    
    @media (max-width: 767.98px) {
        .table th, .table td {
            font-size: 0.875rem;
        }
        .table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
        }
    }
    
    /* Pagination responsiveness */
    .pagination {
        gap: 5px;
    }
    
    @media (max-width: 576px) {
        .pagination .page-link {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Agent search functionality
        const agentSearch = document.getElementById('agentSearch');
        if (agentSearch) {
            agentSearch.addEventListener('keyup', function() {
                const searchTerm = this.value.toLowerCase();
                const agentTable = document.getElementById('agentEarningsTable');
                const rows = agentTable.querySelectorAll('tbody tr.agent-row');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        
        // Export functionality
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                // Simple CSV export of the agent earnings table
                const table = document.getElementById('agentEarningsTable');
                let csv = [];
                const rows = table.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const rowData = [];
                    const cols = row.querySelectorAll('th, td');
                    
                    cols.forEach(col => {
                        rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
                    });
                    
                    csv.push(rowData.join(','));
                });
                
                const csvContent = csv.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'agent_earnings.csv');
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
    });
</script>
{% endblock %}