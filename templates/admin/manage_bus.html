{% extends 'components/base.html' %}
{% block title %}Manage Buses | Go Sewa{% endblock %}
{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="row g-0">
        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-3 rounded-3 shadow-sm" role="alert">
                        <i class="bi bi-info-circle me-2"></i>{{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                <h1 class="h2 fw-bold text-dark">
                    <i class="bi bi-bus-front-fill me-2 text-primary"></i>Manage Buses
                </h1>
                <div class="d-flex gap-2 align-items-center">
                    <button id="addBusBtn" class="btn btn-primary shadow-sm rounded-3 d-none d-md-block">
                        <i class="bi bi-plus-circle-fill me-2"></i>Add Bus
                    </button>
                    <button id="mobileAddBusBtn" class="btn btn-primary shadow-sm rounded-3 d-md-none">
                        <i class="bi bi-plus-circle-fill"></i>
                    </button>
                    <a href="{% url 'busfeature_lists' %}" class="btn btn-outline-primary btn-sm shadow-sm">
                        <i class="bi bi-card-checklist me-1"></i>
                        <span class="d-none d-md-inline">Features</span>
                    </a>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="mb-4">
                <div class="input-group shadow-sm rounded-3" style="max-width: 400px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0" id="searchBuses" placeholder="Search by bus number, type, or counter..." aria-label="Search buses">
                </div>
            </div>

            <!-- Bus Table -->
            <div class="table-responsive rounded-3 shadow-sm">
                <table class="table table-hover align-middle mb-0" id="busesTable">
                    <thead class="text-white" style="background: linear-gradient(45deg, #0d6efd, #5096ff);">
                        <tr>
                            <th scope="col" class="px-3 py-2 sortable" data-sort="bus_number">Bus Number <i class="bi bi-sort-alpha-down ms-1"></i></th>
                            <th scope="col" class="px-3 py-2 sortable" data-sort="bus_type">Type <i class="bi bi-sort-alpha-down ms-1"></i></th>
                            <th scope="col" class="px-3 py-2 sortable" data-sort="total_seats">Seats <i class="bi bi-sort-numeric-down ms-1"></i></th>
                            {% if user.role == 'admin' %}
                            <th scope="col" class="px-3 py-2 sortable" data-sort="counter">Counter</th>
                            {% endif %}
                            <th scope="col" class="px-3 py-2">Features</th>
                            <th scope="col" class="px-3 py-2">Status</th>
                            <th scope="col" class="px-3 py-2 text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bus in buses %}
                        <tr class="bus-row">
                            <td class="px-3 py-2">{{ bus.bus_number }}</td>
                            <td class="px-3 py-2">{{ bus.get_bus_type_display }}</td>
                            <td class="px-3 py-2">{{ bus.total_seats }}</td>
                            {% if user.role == 'admin' %}
                            <td class="px-3 py-2">{{ bus.transportation_company.company_name }}</td>
                            {% endif %}
                            <td class="px-3 py-2">
                                {% if bus.features.all %}
                                    <div class="d-flex flex-wrap gap-1">
                                        {% for feature in bus.features.all %}
                                            <span class="badge bg-primary-subtle text-primary border border-primary rounded-pill d-none d-md-inline">{{ feature.name }}</span>
                                        {% endfor %}
                                        <span class="text-muted small d-md-none">{% for feature in bus.features.all %}{{ feature.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
                                    </div>
                                {% else %}
                                    <span class="text-muted small">None</span>
                                {% endif %}
                            </td>
                            <td class="px-3 py-2">
                                <div class="d-flex gap-1">
                                    {% if bus.is_active %}
                                        <span class="badge bg-success rounded-pill">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger rounded-pill">Inactive</span>
                                    {% endif %}
                                    {% if bus.is_running %}
                                        <span class="badge bg-info rounded-pill">New</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-3 py-2 text-end">
                                <button class="btn btn-outline-warning btn-sm shadow-sm edit-bus-btn" data-bus-id="{{ bus.id }}" title="Edit Bus">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm shadow-sm delete-bus-btn" data-bus-id="{{ bus.id }}" data-bus-number="{{ bus.bus_number }}" title="Delete Bus">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if user.role == 'admin' %}7{% else %}6{% endif %}" class="text-center py-5">
                                <div class="py-4">
                                    <i class="bi bi-bus-front-fill display-4 text-muted mb-3"></i>
                                    <h4 class="text-muted fw-semibold">No Buses Found</h4>
                                    <p class="text-muted mb-4">Get started by adding your first bus.</p>
                                    <button id="emptyAddBusBtnTable" class="btn btn-primary shadow-sm rounded-3">
                                        <i class="bi bi-plus-circle-fill me-2"></i>Add Bus
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if buses.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if buses.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ buses.previous_page_number }}" aria-label="Previous">
                            <span aria-hidden="true">«</span>
                        </a>
                    </li>
                    {% endif %}
                    {% for num in buses.paginator.page_range %}
                    <li class="page-item {% if buses.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endfor %}
                    {% if buses.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ buses.next_page_number }}" aria-label="Next">
                            <span aria-hidden="true">»</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </main>
    </div>
</div>

<!-- Add Bus Modal -->
<div class="modal fade" id="addBusModal" tabindex="-1" aria-labelledby="addBusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-3 shadow-lg">
            <div class="modal-header border-bottom-0 bg-light">
                <h5 class="modal-title fw-bold" id="addBusModalLabel">
                    <i class="bi bi-bus-front-fill me-2 text-primary"></i>Add New Bus
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST" enctype="multipart/form-data" action="{% url 'create_bus' %}" id="addBusForm" novalidate>
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Bus Number <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-bus-front"></i></span>
                                <input type="text" class="form-control rounded-end" name="bus_number" placeholder="e.g., BA 1-2345" required>
                            </div>
                            <div class="invalid-feedback">Please enter a bus number.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Bus Type <span class="text-danger">*</span></label>
                            <select class="form-select rounded-3" name="bus_type" required>
                                {% for value, display in bus_types %}
                                <option value="{{ value }}" {% if value == "deluxe_bus" %}selected{% endif %}>{{ display }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a bus type.</div>
                        </div>
                        {% if user.role == 'admin' %}
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Counter <span class="text-danger">*</span></label>
                            <select class="form-select rounded-3" name="transportation" required>
                                <option value="">-- Select Counter --</option>
                                {% for transportation in transportation_company %}
                                <option value="{{ transportation.id }}">{{ transportation.company_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a counter.</div>
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Driver <span class="text-danger">*</span></label>
                            <select class="form-select rounded-3" name="driver" id="driverSelect" required>
                                <option value="">-- Select Driver --</option>
                                {% for driver in all_drivers %}
                                <option value="{{ driver.id }}">{{ driver.full_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a driver.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Staff <span class="text-danger">*</span></label>
                            <select class="form-select rounded-3" name="staff" id="staffSelect" required>
                                <option value="">-- Select Staff --</option>
                                {% for staff in all_staff %}
                                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a staff member.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Commission Rate (%) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-percent"></i></span>
                                <input type="number" class="form-control rounded-end" name="commission_rate" placeholder="e.g., 10" min="0" max="100" step="0.1" required>
                            </div>
                            <div class="invalid-feedback">Please enter a valid commission rate.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Bus Image</label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-image"></i></span>
                                <input type="file" class="form-control rounded-end" name="bus_image" id="busImageUpload" accept="image/*">
                            </div>
                            <small class="text-muted">Optional: Upload an image of the bus</small>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                                <label class="form-check-label" for="isActive">Active</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-medium">Features</label>
                            <div class="border rounded-3 p-3 bg-light">
                                <div class="row g-2">
                                    {% for value in feature_choices %}
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="features" value="{{ value.name }}" id="feature_{{ value.name }}">
                                            <label class="form-check-label" for="feature_{{ value.name }}">{{ value.name }}</label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <!-- Seat Layout Configuration -->
                        <div class="col-12">
                            <label class="form-label fw-medium">Seat Layout Configuration</label>
                            <div class="border rounded-3 p-3 bg-light">
                                <div class="row g-3">
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Rows</label>
                                        <input type="number" class="form-control rounded-3" id="rowsInput" value="6" min="1">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Columns</label>
                                        <input type="number" class="form-control rounded-3" id="columnsInput" value="5" min="1">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Aisle After Column</label>
                                        <input type="number" class="form-control rounded-3" id="aisleAfterInput" value="2" min="0">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="includeBackRow" checked>
                                            <label class="form-check-label" for="includeBackRow">Include Back Row</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6" id="backRowSeatsContainer">
                                        <label class="form-label">Back Row Seats</label>
                                        <input type="number" class="form-control rounded-3" id="backRowSeatsInput" value="5" min="1">
                                    </div>
                                    <div class="col-12">
                                        <button type="button" class="btn btn-outline-success btn-sm rounded-3 me-2" id="selectAllSeatsBtn">
                                            <i class="bi bi-check-all me-1"></i>Select All
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm rounded-3" id="deselectAllSeatsBtn">
                                            <i class="bi bi-x-circle me-1"></i>Deselect All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Seat Layout Preview -->
                        <div class="col-12">
                            <label class="form-label fw-medium">Seat Layout Preview</label>
                            <div class="border rounded-3 p-3 bg-light">
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="fw-medium">Total Selected Seats: <span id="selectedSeatsCount">0</span></span>
                                </div>
                                <div id="seatLayoutContainer" class="d-grid gap-2"></div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="layout" id="layoutData">
                    <input type="hidden" name="add_bus" value="1">
                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-outline-secondary rounded-3 me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary rounded-3">
                            <i class="bi bi-plus-circle-fill me-1"></i>Add Bus
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Bus Modal -->
<div class="modal fade" id="editBusModal" tabindex="-1" aria-labelledby="editBusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content rounded-3 shadow-lg">
            <div class="modal-header border-bottom-0 bg-light">
                <h5 class="modal-title fw-bold" id="editBusModalLabel">
                    <i class="bi bi-bus-front-fill me-2 text-primary"></i>Edit Bus
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form method="POST" enctype="multipart/form-data" id="editBusForm" novalidate>
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Bus Number <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-bus-front"></i></span>
                                <input type="text" class="form-control rounded-end" name="bus_number" id="edit_bus_number" placeholder="e.g., BA 1-2345" required>
                            </div>
                            <div class="invalid-feedback">Please enter a bus number.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Bus Type <span class="text-danger">*</span></label>
                            <select class="form-select rounded-3" name="bus_type" id="edit_bus_type" required>
                                {% for value, display in bus_types %}
                                <option value="{{ value }}">{{ display }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Please select a bus type.</div>
                        </div>
                        {% if user.role == 'admin' %}
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Counter</label>
                            <select class="form-select rounded-3" name="transportation" id="edit_transportation">
                                <option value="">-- Select Counter --</option>
                                {% for transportation in transportation_company %}
                                <option value="{{ transportation.id }}">{{ transportation.company_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Driver</label>
                            <select class="form-select rounded-3" name="driver" id="edit_driver">
                                <option value="">-- Select Driver --</option>
                                {% for driver in all_drivers %}
                                <option value="{{ driver.id }}">{{ driver.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Staff</label>
                            <select class="form-select rounded-3" name="staff" id="edit_staff">
                                <option value="">-- Select Staff --</option>
                                {% for staff in all_staff %}
                                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Commission Rate (%) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-percent"></i></span>
                                <input type="number" class="form-control rounded-end" name="commission_rate" id="edit_commission" placeholder="e.g., 10" min="0" max="100" step="0.1" required {% if not user.role == "admin" %} readonly {% endif %}>
                            </div>
                            <div class="invalid-feedback">Please enter a valid commission rate.</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-medium">Bus Image</label>
                            <div class="input-group">
                                <span class="input-group-text rounded-start"><i class="bi bi-image"></i></span>
                                <input type="file" class="form-control rounded-end" name="bus_image" id="edit_busImageUpload" accept="image/*">
                            </div>
                            <div id="current_image_preview" class="mt-2"></div>
                            <small class="text-muted">Optional: Upload a new image to replace the current one</small>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" name="is_active" id="edit_isActive">
                                <label class="form-check-label" for="edit_isActive">Active</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-medium">Features</label>
                            <div class="border rounded-3 p-3 bg-light">
                                <div class="row g-2">
                                    {% for value in feature_choices %}
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="features" value="{{ value.name }}" id="edit_feature_{{ value.name }}">
                                            <label class="form-check-label" for="edit_feature_{{ value.name }}">{{ value.name }}</label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <!-- Seat Layout Configuration -->
                        <div class="col-12">
                            <label class="form-label fw-medium">Seat Layout Configuration</label>
                            <div class="border rounded-3 p-3 bg-light">
                                <div class="row g-3">
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Rows</label>
                                        <input type="number" class="form-control rounded-3" id="edit_rowsInput" value="6" min="1">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Columns</label>
                                        <input type="number" class="form-control rounded-3" id="edit_columnsInput" value="5" min="1">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <label class="form-label">Aisle After Column</label>
                                        <input type="number" class="form-control rounded-3" id="edit_aisleAfterInput" value="2" min="0">
                                    </div>
                                    <div class="col-md-3 col-6">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="edit_includeBackRow" checked>
                                            <label class="form-check-label" for="edit_includeBackRow">Include Back Row</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-6" id="edit_backRowSeatsContainer">
                                        <label class="form-label">Back Row Seats</label>
                                        <input type="number" class="form-control rounded-3" id="edit_backRowSeatsInput" value="5" min="1">
                                    </div>
                                    <div class="col-12">
                                        <button type="button" class="btn btn-outline-success btn-sm rounded-3 me-2" id="edit_selectAllSeatsBtn">
                                            <i class="bi bi-check-all me-1"></i>Select All
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm rounded-3" id="edit_deselectAllSeatsBtn">
                                            <i class="bi bi-x-circle me-1"></i>Deselect All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Seat Layout Preview -->
                        <div class="col-12">
                            <label class="form-label fw-medium">Seat Layout Preview</label>
                            <div class="border rounded-3 p-3 bg-light">
                                <div class="d-flex justify-content-between mb-3">
                                    <span class="fw-medium">Total Selected Seats: <span id="edit_selectedSeatsCount">0</span></span>
                                </div>
                                <div id="edit_seatLayoutContainer" class="d-grid gap-2"></div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="layout" id="edit_layoutData">
                    <input type="hidden" name="bus_id" id="edit_bus_id">
                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-outline-secondary rounded-3 me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning rounded-3">
                            <i class="bi bi-pencil-square me-1"></i>Update Bus
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-3 shadow-sm">
            <div class="modal-header border-bottom-0 bg-light">
                <h5 class="modal-title fw-bold" id="deleteConfirmModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-1 text-danger"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Delete bus <strong id="deleteBusNumber"></strong>?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-outline-secondary btn-sm rounded-3" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteBusForm" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm rounded-3">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.btn-outline-primary {
    color: #0d6efd;
    border-color: #0d6efd;
}

.btn-outline-primary:hover {
    color: #fff;
    background-color: #0d6efd;
}

.btn-outline-warning {
    color: #ffc107;
    border-color: #ffc107;
}

.btn-outline-warning:hover {
    color: #fff;
    background-color: #ffc107;
}

.btn-outline-danger {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-outline-danger:hover {
    color: #fff;
    background-color: #dc3545;
}

.btn-outline-success {
    color: #198754;
    border-color: #198754;
}

.btn-outline-success:hover {
    color: #fff;
    background-color: #198754;
}

.form-control, .form-select {
    border-radius: 0.5rem;
    border: 1px solid #ced4da;
    transition: border-color 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.input-group-text {
    background-color: #f8f9fa;
}

.badge {
    font-size: 0.75rem;
    padding: 0.3em 0.6em;
}

.pagination .page-link {
    border-radius: 0.5rem;
    margin: 0 0.25rem;
    padding: 0.5rem 0.75rem;
}

.pagination .page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.modal-content {
    border-radius: 0.75rem;
    animation: fadeIn 0.3s ease;
}

.seat-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    text-align: center;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
    font-size: 0.9rem;
    background-color: #fff;
}

.seat-item:hover:not(.aisle):not(.booked) {
    background-color: #e9ecef;
}

.seat-item.selected {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.seat-item.aisle {
    background-color: #f8f9fa;
    border: none;
    cursor: default;
}

.seat-item.booked {
    background-color: #6c757d;
    color: white;
    cursor: not-allowed;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@media (max-width: 767.98px) {
    .table td, .table th {
        font-size: 0.85rem;
        padding: 0.5rem;
    }
    .btn, .form-control, .form-select {
        font-size: 0.95rem;
    }
    .badge {
        font-size: 0.7rem;
    }
    .seat-item {
        padding: 0.5rem;
        font-size: 0.8rem;
    }
}

@media (max-width: 575.98px) {
    .container-fluid {
        padding-left: 1rem;
        padding-right: 1rem;
    }
    .pagination .page-link {
        padding: 0.4rem 0.6rem;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Bootstrap modals
    const addBusModal = new bootstrap.Modal(document.getElementById('addBusModal'));
    const editBusModal = new bootstrap.Modal(document.getElementById('editBusModal'));
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

    // Show Add Bus Modal
    const addButtons = [
        document.getElementById('addBusBtn'),
        document.getElementById('mobileAddBusBtn'),
        document.getElementById('emptyAddBusBtnTable')
    ];
    addButtons.forEach(button => {
        if (button) {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                initializeSeatLayout();
                addBusModal.show();
            });
        }
    });

    // Search functionality
    const searchInput = document.getElementById('searchBuses');
    if (searchInput) {
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const busRows = document.querySelectorAll('.bus-row');
            busRows.forEach(row => {
                const busNumber = row.cells[0].textContent.toLowerCase();
                const busType = row.cells[1].textContent.toLowerCase();
                const busCounter = row.cells[{% if user.role == 'admin' %}3{% else %}2{% endif %}]?.textContent.toLowerCase() || '';
                const isVisible = busNumber.includes(searchTerm) || busType.includes(searchTerm) || busCounter.includes(searchTerm);
                row.style.display = isVisible ? '' : 'none';
            });
        });
    }

    // Client-side sorting
    const sortableHeaders = document.querySelectorAll('.sortable');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            const table = document.getElementById('busesTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('.bus-row'));
            const isAscending = header.classList.toggle('asc');
            
            rows.sort((a, b) => {
                let aValue, bValue;
                switch (sortKey) {
                    case 'bus_number':
                        aValue = a.cells[0].textContent;
                        bValue = b.cells[0].textContent;
                        break;
                    case 'bus_type':
                        aValue = a.cells[1].textContent;
                        bValue = b.cells[1].textContent;
                        break;
                    case 'total_seats':
                        aValue = parseInt(a.cells[2].textContent);
                        bValue = parseInt(b.cells[2].textContent);
                        break;
                    case 'counter':
                        aValue = a.cells[3]?.textContent || '';
                        bValue = b.cells[3]?.textContent || '';
                        break;
                }
                if (typeof aValue === 'number') {
                    return isAscending ? aValue - bValue : bValue - aValue;
                }
                return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));

            sortableHeaders.forEach(h => {
                h.querySelector('i').className = 'bi bi-sort-alpha-down ms-1';
            });
            header.querySelector('i').className = isAscending ? 'bi bi-sort-alpha-down ms-1' : 'bi bi-sort-alpha-up ms-1';
        });
    });

    // Seat Layout Functions
    function updateGridLayout(containerId, columns, aisleAfter) {
        const container = document.getElementById(containerId);
        if (!container) return;
        let gridTemplateColumns = '';
        for (let i = 0; i < columns; i++) {
            gridTemplateColumns += (i === aisleAfter ? '0.5fr ' : '1fr ');
        }
        container.style.gridTemplateColumns = gridTemplateColumns.trim();
    }

    function generateSeatLayout(containerId, rows, columns, aisleAfter, includeBackRow, backRowSeats, existingLayout = null) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';
        updateGridLayout(containerId, columns, aisleAfter);

        let layout = [];
        let totalSeats = 0;

        for (let r = 0; r < rows; r++) {
            const row = [];
            for (let c = 0; c < columns; c++) {
                if (c === aisleAfter) {
                    const aisle = document.createElement('div');
                    aisle.className = 'seat-item aisle';
                    aisle.textContent = ' ';
                    container.appendChild(aisle);
                    row.push({ seat: 'AISLE', status: 'aisle' });
                    continue;
                }

                const effectiveCol = c > aisleAfter ? c - 1 : c;
                const seatNumber = `${String.fromCharCode(65 + effectiveCol)}${r + 1}`;
                const seat = document.createElement('div');
                seat.className = 'seat-item';
                seat.textContent = seatNumber;
                seat.dataset.seat = seatNumber;
                seat.dataset.row = r;
                seat.dataset.col = effectiveCol;

                let isSelected = existingLayout ? false : true;
                if (existingLayout?.layout) {
                    const rowData = existingLayout.layout[r];
                    if (rowData && rowData[c] && rowData[c].status === 'available') {
                        isSelected = true;
                    } else if (rowData && rowData[c] && rowData[c].status === 'booked') {
                        seat.classList.add('booked');
                        isSelected = false;
                    }
                }

                if (isSelected) {
                    seat.classList.add('selected');
                }

                if (!seat.classList.contains('booked')) {
                    seat.addEventListener('click', () => {
                        seat.classList.toggle('selected');
                        updateLayoutData(containerId === 'seatLayoutContainer');
                    });
                }

                container.appendChild(seat);
                row.push({ seat: seatNumber, status: isSelected ? 'available' : 'unavailable' });
                if (isSelected) totalSeats++;
            }
            layout.push(row);
        }

        if (includeBackRow) {
            const backRowLabel = document.createElement('div');
            backRowLabel.className = 'w-100 text-center mt-3 mb-2 fw-medium';
            backRowLabel.textContent = 'Back Row';
            backRowLabel.style.gridColumn = '1 / -1';
            container.appendChild(backRowLabel);

            const backRowContainer = document.createElement('div');
            backRowContainer.className = 'd-flex justify-content-center w-100';
            backRowContainer.style.gridColumn = '1 / -1';
            container.appendChild(backRowContainer);

            const backRow = [];
            for (let c = 0; c < backRowSeats; c++) {
                const seatNumber = `${String.fromCharCode(65 + c)}${rows + 1}`;
                const seat = document.createElement('div');
                seat.className = 'seat-item mx-1';
                seat.textContent = seatNumber;
                seat.dataset.seat = seatNumber;
                seat.dataset.row = rows;
                seat.dataset.col = c;

                let isSelected = existingLayout ? false : true;
                if (existingLayout?.layout) {
                    const backRowData = existingLayout.layout[rows];
                    if (backRowData && backRowData[c] && backRowData[c].status === 'available') {
                        isSelected = true;
                    } else if (backRowData && backRowData[c] && backRowData[c].status === 'booked') {
                        seat.classList.add('booked');
                        isSelected = false;
                    }
                }

                if (isSelected) {
                    seat.classList.add('selected');
                }

                if (!seat.classList.contains('booked')) {
                    seat.addEventListener('click', () => {
                        seat.classList.toggle('selected');
                        updateLayoutData(containerId === 'seatLayoutContainer');
                    });
                }

                backRowContainer.appendChild(seat);
                backRow.push({ seat: seatNumber, status: isSelected ? 'available' : 'unavailable' });
                if (isSelected) totalSeats++;
            }
            layout.push(backRow);
        }

        updateSeatCount(containerId, totalSeats);
        return layout;
    }

    function updateLayoutData(isAddModal = true) {
        const prefix = isAddModal ? '' : 'edit_';
        const rows = parseInt(document.getElementById(prefix + 'rowsInput').value) || 6;
        const columns = parseInt(document.getElementById(prefix + 'columnsInput').value) || 5;
        const aisleAfter = parseInt(document.getElementById(prefix + 'aisleAfterInput').value) || 2;
        const includeBackRow = document.getElementById(prefix + 'includeBackRow').checked;
        const backRowSeats = parseInt(document.getElementById(prefix + 'backRowSeatsInput').value) || 5;
        const containerId = isAddModal ? 'seatLayoutContainer' : 'edit_seatLayoutContainer';

        const seats = document.querySelectorAll(`#${containerId} .seat-item:not(.aisle)`);
        let layout = [];
        let totalSeats = 0;

        for (let r = 0; r < (includeBackRow ? rows + 1 : rows); r++) {
            const row = [];
            const rowSeats = Array.from(seats).filter(seat => parseInt(seat.dataset.row) === r);

            if (r < rows) {
                for (let c = 0; c < columns; c++) {
                    if (c === aisleAfter) {
                        row.push({ seat: 'AISLE', status: 'aisle' });
                        continue;
                    }
                    const effectiveCol = c > aisleAfter ? c - 1 : c;
                    const seatNumber = `${String.fromCharCode(65 + effectiveCol)}${r + 1}`;
                    const seat = rowSeats.find(s => s.dataset.seat === seatNumber);
                    const isSelected = seat?.classList.contains('selected') || false;
                    const isBooked = seat?.classList.contains('booked') || false;
                    const status = isBooked ? 'booked' : (isSelected ? 'available' : 'unavailable');
                    row.push({ seat: seatNumber, status });
                    if (status === 'available') totalSeats++;
                }
            } else if (includeBackRow) {
                for (let c = 0; c < backRowSeats; c++) {
                    const seatNumber = `${String.fromCharCode(65 + c)}${r + 1}`;
                    const seat = rowSeats.find(s => s.dataset.seat === seatNumber);
                    const isSelected = seat?.classList.contains('selected') || false;
                    const isBooked = seat?.classList.contains('booked') || false;
                    const status = isBooked ? 'booked' : (isSelected ? 'available' : 'unavailable');
                    row.push({ seat: seatNumber, status });
                    if (status === 'available') totalSeats++;
                }
            }
            layout.push(row);
        }

        const layoutData = { rows, columns, aisleAfterColumn: aisleAfter, includeBackRow, backRowSeats, layout, totalSeats };
        document.getElementById(prefix + 'layoutData').value = JSON.stringify(layoutData);
        document.getElementById(prefix + 'selectedSeatsCount').textContent = totalSeats;
    }

    function updateSeatCount(containerId, count) {
        const prefix = containerId === 'seatLayoutContainer' ? '' : 'edit_';
        document.getElementById(prefix + 'selectedSeatsCount').textContent = count;
    }

    function initializeSeatLayout() {
        const rows = parseInt(document.getElementById('rowsInput').value) || 6;
        const columns = parseInt(document.getElementById('columnsInput').value) || 5;
        const aisleAfter = parseInt(document.getElementById('aisleAfterInput').value) || 2;
        const includeBackRow = document.getElementById('includeBackRow').checked;
        const backRowSeats = parseInt(document.getElementById('backRowSeatsInput').value) || 5;

        generateSeatLayout('seatLayoutContainer', rows, columns, aisleAfter, includeBackRow, backRowSeats);
        updateLayoutData(true);
    }

    function initializeEditSeatLayout(layoutData = null) {
        const rows = parseInt(document.getElementById('edit_rowsInput').value) || 6;
        const columns = parseInt(document.getElementById('edit_columnsInput').value) || 5;
        const aisleAfter = parseInt(document.getElementById('edit_aisleAfterInput').value) || 2;
        const includeBackRow = document.getElementById('edit_includeBackRow').checked;
        const backRowSeats = parseInt(document.getElementById('edit_backRowSeatsInput').value) || 5;

        generateSeatLayout('edit_seatLayoutContainer', rows, columns, aisleAfter, includeBackRow, backRowSeats, layoutData);
        updateLayoutData(false);
    }

    function setupRealtimeListeners(prefix = '') {
        const inputs = ['rowsInput', 'columnsInput', 'aisleAfterInput', 'backRowSeatsInput'];
        inputs.forEach(id => {
            const input = document.getElementById(prefix + id);
            if (input) {
                input.addEventListener('change', () => {
                    if (prefix === 'edit_') {
                        initializeEditSeatLayout();
                    } else {
                        initializeSeatLayout();
                    }
                });
            }
        });

        const includeBackRow = document.getElementById(prefix + 'includeBackRow');
        if (includeBackRow) {
            includeBackRow.addEventListener('change', () => {
                document.getElementById(prefix + 'backRowSeatsContainer').style.display = includeBackRow.checked ? '' : 'none';
                if (prefix === 'edit_') {
                    initializeEditSeatLayout();
                } else {
                    initializeSeatLayout();
                }
            });
        }

        const containerId = prefix === '' ? 'seatLayoutContainer' : 'edit_seatLayoutContainer';
        const selectAllBtn = document.getElementById(prefix + 'selectAllSeatsBtn');
        const deselectAllBtn = document.getElementById(prefix + 'deselectAllSeatsBtn');

        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', () => {
                document.querySelectorAll(`#${containerId} .seat-item:not(.aisle):not(.booked)`).forEach(seat => seat.classList.add('selected'));
                updateLayoutData(prefix === '');
            });
        }

        if (deselectAllBtn) {
            deselectAllBtn.addEventListener('click', () => {
                document.querySelectorAll(`#${containerId} .seat-item:not(.aisle):not(.booked)`).forEach(seat => seat.classList.remove('selected'));
                updateLayoutData(prefix === '');
            });
        }
    }

    setupRealtimeListeners('');
    setupRealtimeListeners('edit_');

    // Edit Bus Handling
    document.querySelectorAll('.edit-bus-btn').forEach(button => {
        button.addEventListener('click', () => {
            const busId = button.dataset.busId;
            document.getElementById('editBusForm').action = `/edit-bus/${busId}/`;
            document.getElementById('edit_bus_id').value = busId;

            fetch(`/get_bus/${busId}/`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('edit_bus_number').value = data.bus_number || '';
                    document.getElementById('edit_bus_type').value = data.bus_type || '';
                    document.getElementById('edit_isActive').checked = data.is_active || false;

                    // Set Driver
                    const driverSelect = document.getElementById('edit_driver');
                    driverSelect.value = data.driver_id || ''; // Use driver_id from backend

                    // Set Staff
                    const staffSelect = document.getElementById('edit_staff');
                    staffSelect.value = data.staff_id || ''; // Use staff_id from backend

                    // Set Commission Rate
                    const commissionInput = document.getElementById('edit_commission');
                    if (commissionInput) {
                        commissionInput.value = data.rate || 0;
                    }

                    // Set Transportation (Counter)
                    const transportationSelect = document.getElementById('edit_transportation');
                    if (transportationSelect && data.transportation_company) {
                        transportationSelect.value = data.transportation_company;
                    }

                    // Set Features
                    document.querySelectorAll('#editBusForm .form-check-input[name="features"]').forEach(checkbox => {
                        checkbox.checked = data.features.includes(checkbox.value);
                    });

                    // Set Seat Layout
                    const layout = JSON.parse(data.layout || '{}');
                    document.getElementById('edit_rowsInput').value = layout.rows || 6;
                    document.getElementById('edit_columnsInput').value = layout.columns || 5;
                    document.getElementById('edit_aisleAfterInput').value = layout.aisleAfterColumn || 2;
                    document.getElementById('edit_includeBackRow').checked = layout.includeBackRow !== false;
                    document.getElementById('edit_backRowSeatsInput').value = layout.backRowSeats || 5;
                    document.getElementById('edit_backRowSeatsContainer').style.display = layout.includeBackRow !== false ? '' : 'none';

                    // Set Bus Image Preview
                    const imagePreview = document.getElementById('current_image_preview');
                    if (data.bus_image) {
                        imagePreview.innerHTML = `
                            <img src="${data.bus_image}" alt="Current Bus Image" class="img-thumbnail rounded-3" style="max-height: 100px">
                            <div class="small text-muted mt-1">Current image</div>
                        `;
                    } else {
                        imagePreview.innerHTML = '';
                    }

                    initializeEditSeatLayout(layout);
                    editBusModal.show();
                })
                .catch(error => {
                    console.error('Error fetching bus data:', error);
                    alert('Failed to load bus data. Please try again.');
                });
        });
    });

    // Edit Form Submission
    const editBusForm = document.getElementById('editBusForm');
    if (editBusForm) {
        editBusForm.addEventListener('submit', (e) => {
            e.preventDefault();
            updateLayoutData(false);

            const formData = new FormData(editBusForm);
            fetch(editBusForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        editBusModal.hide();
                        window.location.href = data.redirect;
                    }
                })
                .catch(error => {
                    console.error('Error updating bus:', error);
                    alert('Failed to update bus. Please try again.');
                });
        });
    }

    // Delete Handling
    document.querySelectorAll('.delete-bus-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            const busId = button.dataset.busId;
            const busNumber = button.dataset.busNumber;
            document.getElementById('deleteBusNumber').textContent = busNumber;
            document.getElementById('deleteBusForm').action = `/delete-bus/${busId}/`;
            deleteConfirmModal.show();
        });
    });

    // Form Validation
    const forms = [document.getElementById('addBusForm'), document.getElementById('editBusForm')];
    forms.forEach(form => {
        if (form) {
            form.addEventListener('submit', (e) => {
                if (!form.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                form.classList.add('was-validated');
            });
        }
    });
});
</script>
{% endblock %}