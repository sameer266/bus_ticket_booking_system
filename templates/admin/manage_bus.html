{% extends 'components/base.html' %}
{% block title %}Manage Buses | Go Sewa{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row g-0">
       
        <!-- Main Content -->
        <main class=" col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4 main-content ">


            <!-- Mesage --> 
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 mt-4">
                <h1 class="h2 fw-bold">
                    <i class="bi bi-bus-front me-2 text-primary"></i>Manage Buses
                </h1>
                <div class="btn-toolbar d-none d-md-flex">
                    <div class="btn-group me-2">
                        <button id="addBusBtn" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus-lg me-1"></i> New Bus
                        </button>
                    </div>
                </div>
            </div>
            <!-- Mobile Action Buttons -->
            <div class="d-flex d-md-none mb-3 gap-2">
                <button id="mobileAddBusBtn" class="btn btn-primary flex-grow-1">
                    <i class="bi bi-plus-lg me-1"></i> Add Bus
                </button>
            </div>
            <!-- Buses List Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-bus-front me-2"></i>Bus List
                    </h5>
                    <div class="input-group input-group-sm w-auto">
                        <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control border-start-0 ps-0" id="searchBuses" placeholder="Search buses..." style="max-width: 200px;">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Bus</th>
                                    {% if user.role == 'admin' %}
                                    <th class="ps-3">Counter </th>
                                    {% endif %}
                                    
                                    <th class="d-none d-md-table-cell">Type</th>
                                    <th class="-md-table-cell">Seats</th>
                                    <th class="d-none d-md-table-cell">Features</th>
                                    <th class="d-none d-md-table-cell">Status</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bus in buses %}
                                <tr>
                                    <td class="ps-3">
                                        <div class="d-flex align-items-center">
                                            {% if bus.bus_image %}
                                                <img src="{{ bus.bus_image.url }}" alt="Bus" class="rounded me-3" width="50" height="40">
                                            {% else %}
                                                <div class="rounded bg-secondary text-white d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 40px;">
                                                    <i class="bi bi-bus-front"></i>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-0">{{ bus.bus_number }}</h6>
                                                
                                            </div>
                                        </div>
                                    </td>
                                    {% if user.role == 'admin' %}
                                    <td class="p3"> {{bus.transportation_company.company_name}}</td>
                                    {% endif %}

                                    <td class="d-none d-md-table-cell">{{ bus.get_bus_type_display }}</td>
                                    <td class=" d-md-table-cell">{{ bus.total_seats }}</td>
                                    <td class="d-none d-md-table-cell">
                                        {% if bus.features %}
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for feature in bus.features %}
                                                    <span class="badge bg-light text-dark border">{{ feature }}</span>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <div class="d-flex gap-1">
                                            {% if bus.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                            {% if bus.is_running %}
                                                <span class="badge bg-info">Running</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-end pe-3">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button class="btn btn-sm btn-outline-warning edit-bus-btn" data-bus-id="{{ bus.id }}" title="Edit Bus">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                           
                                            <button class="btn btn-sm btn-outline-danger delete-bus-btn" data-bus-id="{{ bus.id }}" data-bus-number="{{ bus.bus_number }}" title="Delete Bus">
                                                <i class="bi bi-trash"></i>
                                            </button>



                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-5">
                                        <div class="py-4">
                                            <i class="bi bi-bus-front display-5 text-muted d-block mb-3"></i>
                                            <h5 class="text-muted">No buses found</h5>
                                            <p class="text-muted">Add your first bus to get started</p>
                                            <button id="emptyAddBusBtn" class="btn btn-primary mt-2">
                                                <i class="bi bi-plus-circle me-1"></i> Add Bus
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>



<!-- Add Bus Modal -->
<div class="modal fade" id="addBusModal" tabindex="-1" aria-labelledby="addBusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBusModalLabel"><i class="bi bi-bus-front me-2 text-primary"></i>Add New Bus</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data" action="{% url 'create_bus' %}" id="addBusForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Bus Number*</label>
                            <input type="text" class="form-control" name="bus_number" placeholder="BA 1-2345" required>
                        </div>
                        <!-- In the add bus modal -->
                        <div class="col-md-6">
                            <label class="form-label">Bus Type*</label>
                            <select class="form-select" name="bus_type" required>
                                {% for value, display in bus_types %}
                                <option value="{{ value }}" {% if value == "deluxe_bus" %}selected{% endif %}>{{ display }}</option>
                                {% endfor %}
                            </select>
                        </div>

                 

                    {% if user.role == 'admin' %}
                        <div class="col-md-6">
                            <label class="form-label">Counter* </label>
                            <select class="form-select" name="transportation" id="driverSelect" required>
                                <option value="">-- Select Counter --</option>
                                {% for transportation in transportation_company %}
                                <option value="{{ transportation.id }}">{{ transportation.company_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}


                        <div class="col-md-6">
                            <label class="form-label">Driver*</label>
                            <select class="form-select" name="driver" id="driverSelect" required>
                                <option value="">-- Select Driver --</option>
                                {% for driver in all_drivers %}
                                <option value="{{ driver.id }}">{{ driver.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Staff*</label>
                            <select class="form-select" name="staff" id="staffSelect" required>
                                <option value="">-- Select Staff --</option>
                                {% for staff in all_staff %}
                                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Features</label>
                            <div class="border rounded p-3">
                                <div class="row g-2" id="edit_features_container">
                                    {% for value, display in feature_choices %}
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="features" value="{{ value }}" id="edit_feature_{{ value }}">
                                            <label class="form-check-label" for="edit_feature_{{ value }}">{{ display }}</label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Bus Image</label>
                            <div class="input-group">
                                <input type="file" class="form-control" name="bus_image" id="busImageUpload">
                                <label class="input-group-text" for="busImageUpload"><i class="bi bi-upload"></i></label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mt-4">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                                    <label class="form-check-label" for="isActive">Active</label>
                                </div>
                               
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Commission Rate (%)*</label>
                            <input type="number" class="form-control" name="commission_rate" placeholder="Enter commission percentage" min="0" max="100" step="0.1" required>
                        </div>

                        
                        <!-- Bus Layout Configuration -->
                        <div class="col-md-12">
                            <label class="form-label">Seat Layout Configuration</label>
                            <div class="border rounded p-3">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Rows</label>
                                        <input type="number" class="form-control" id="rowsInput" value="6" min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Columns</label>
                                        <input type="number" class="form-control" id="columnsInput" value="5" min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Aisle After Column</label>
                                        <input type="number" class="form-control" id="aisleAfterInput" value="2" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mt-4 pt-2">
                                            <input class="form-check-input" type="checkbox" id="includeBackRow" checked>
                                            <label class="form-check-label" for="includeBackRow">Include Back Row</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3" id="backRowSeatsContainer">
                                        <label class="form-label">Back Row Seats</label>
                                        <input type="number" class="form-control" id="backRowSeatsInput" value="5" min="1">
                                    </div>
                                    <div class="col-md-12">
                                       
                                        <button type="button" class="btn btn-sm btn-outline-success me-2" id="selectAllSeatsBtn">
                                            <i class="bi bi-check-all me-1"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="deselectAllSeatsBtn">
                                            <i class="bi bi-x-circle me-1"></i> Deselect All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seat Layout Preview -->
                        <div class="col-md-12">
                            <label class="form-label">Seat Layout Preview</label>
                            <div class="border rounded p-3">
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Total Selected Seats: <span id="selectedSeatsCount">0</span></span>
                                </div>
                                <div id="seatLayoutContainer" class="d-grid gap-2" style="grid-template-columns: repeat(5, 1fr);">
                                    <!-- Seat layout will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="layout" id="layoutData">
                    <input type="hidden" name="add_bus" value="1">

                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i> Add Bus
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Bus Modal -->
<div class="modal fade" id="editBusModal" tabindex="-1" aria-labelledby="editBusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBusModalLabel"><i class="bi bi-bus-front me-2 text-primary"></i>Edit Bus</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data" id="editBusForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Bus Number*</label>
                            <input type="text" class="form-control" name="bus_number" id="edit_bus_number" placeholder="BA 1-2345" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bus Type*</label>
                            <select class="form-select" name="bus_type" id="edit_bus_type" required>
                                {% for value, display in bus_types %}
                                <option value="{{ value }}">{{ display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                       

                        <div class="col-md-6">
                            <label class="form-label">Total Seats*</label>
                            <input type="number" class="form-control" name="total_seats" id="edit_total_seats" min="1" required readonly>
                        </div>

                        {% if user.role == 'admin' %}
                        <div class="col-md-6">
                            <label class="form-label">Counter </label>
                            <select class="form-select" name="transportation" id="edit_transportation">
                                <option value="">-- Select Counter --</option>
                                {% for transportation in transportation_company %}
                                <option value="{{ transportation.id }}">{{ transportation.company_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="col-md-6">
                            <label class="form-label">Driver</label>
                            <select class="form-select" name="driver" id="edit_driver">
                                <option value="">-- Select Driver --</option>
                                {% for driver in all_drivers %}
                                <option value="{{ driver.id }}">{{ driver.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Staff</label>
                            <select class="form-select" name="staff" id="edit_staff">
                                <option value="">-- Select Staff --</option>
                                {% for staff in all_staff %}

                                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-12">
                            <label class="form-label">Features</label>
                            <div class="border rounded p-3">
                                <div class="row g-2" id="edit_features_container">
                                    {% for value, display in feature_choices %}
                                    <div class="col-md-3 col-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="features" value="{{ value }}" id="edit_feature_{{ value }}">
                                            <label class="form-check-label" for="edit_feature_{{ value }}">{{ display }}</label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Bus Image</label>
                            <div class="input-group">
                                <input type="file" class="form-control" name="bus_image" id="edit_busImageUpload">
                                <label class="input-group-text" for="edit_busImageUpload"><i class="bi bi-upload"></i></label>
                            </div>
                            <div id="current_image_preview" class="mt-2"></div>
                        </div>

                        {% if user.role == "admin" %}
                        <div class="col-md-6">
                            <label class="form-label" for="edit_commission">Commission Rate (%)*</label>
                            <input type="number" class="form-control" name="commission_rate" id="edit_commission"placeholder="Enter commission percentage" min="0" max="100" step="0.1" required>
                        </div>
                        {% endif %}

                        
                        <div class="col-md-6">
                            <div class="mt-4">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="edit_isActive">
                                    <label class="form-check-label" for="edit_isActive">Active</label>
                                </div>
                              
                            </div>
                        </div>
                        
                        <!-- Bus Layout Configuration for Edit -->
                        <div class="col-md-12">
                            <label class="form-label">Seat Layout Configuration</label>
                            <div class="border rounded p-3">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label">Rows</label>
                                        <input type="number" class="form-control" id="edit_rowsInput" value="6" min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Columns</label>
                                        <input type="number" class="form-control" id="edit_columnsInput" value="5" min="1">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Aisle After Column</label>
                                        <input type="number" class="form-control" id="edit_aisleAfterInput" value="2" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mt-4 pt-2">
                                            <input class="form-check-input" type="checkbox" id="edit_includeBackRow" checked>
                                            <label class="form-check-label" for="edit_includeBackRow">Include Back Row</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3" id="edit_backRowSeatsContainer">
                                        <label class="form-label">Back Row Seats</label>
                                        <input type="number" class="form-control" id="edit_backRowSeatsInput" value="5" min="1">
                                    </div>
                                    <div class="col-md-12">
                                       
                                        <button type="button" class="btn btn-sm btn-outline-success me-2" id="edit_selectAllSeatsBtn">
                                            <i class="bi bi-check-all me-1"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="edit_deselectAllSeatsBtn">
                                            <i class="bi bi-x-circle me-1"></i> Deselect All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seat Layout Preview for Edit -->
                        <div class="col-md-12">
                            <label class="form-label">Seat Layout Preview</label>
                            <div class="border rounded p-3">
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Total Selected Seats: <span id="edit_selectedSeatsCount">0</span></span>
                                </div>
                                <div id="edit_seatLayoutContainer" class="d-grid gap-2" style="grid-template-columns: repeat(5, 1fr);">
                                    <!-- Seat layout will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="layout" id="edit_layoutData">
                    <input type="hidden" name="bus_id" id="edit_bus_id">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editBusForm" class="btn btn-warning">
                    <i class="bi bi-pencil-square me-1"></i> Update Bus
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this bus? This action cannot be undone.</p>
                <p class="fw-bold" id="deleteBusNumber"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteBusForm" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i> Delete Bus
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_css %}
<style>
  

    /* Action Buttons */
.action-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1;
}

.btn-outline-warning {
    color: #ffc107;
    border-color: #ffc107;
}

.btn-outline-warning:hover {
    color: #fff;
    background-color: #ffc107;
    border-color: #ffc107;
}

.btn-outline-danger {
    color: #dc3545;
    border-color: #dc3545;
}

.btn-outline-danger:hover {
    color: #fff;
    background-color: #dc3545;
    border-color: #dc3545;
}
    
    /* Seat Layout Styles */
    .seat-item {
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        text-align: center;
        cursor: pointer;
        user-select: none;
        border-radius: 0.25rem;
    }
    .seat-item.selected {
        background-color: #0d6efd;
        color: white;
    }
    .seat-item.aisle {
        background-color: #f8f9fa;
        cursor: default;
    }
    #seatLayoutContainer, #edit_seatLayoutContainer {
        grid-template-columns: repeat(var(--columns, 5), 1fr);
    }
</style>
{% endblock %}

{% block extra_js %}

<script>
$(document).ready(function() {
    // Bootstrap initialization
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    const addBusModal = new bootstrap.Modal($('#addBusModal')[0], { backdrop: true });
    const editBusModal = new bootstrap.Modal($('#editBusModal')[0], { backdrop: true });
    const deleteConfirmModal = new bootstrap.Modal($('#deleteConfirmModal')[0], { backdrop: true });
    
    // Clean up modals when hidden
    $('#addBusModal, #editBusModal, #deleteConfirmModal').on('hidden.bs.modal', function () {
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open');
        $('body').css({
            'overflow': '',
            'padding-right': ''
        });
    });

    // Grid layout function
    function updateGridLayout(containerId, columns, aisleAfter) {
        const $container = $('#' + containerId);
        if ($container.length === 0) return;
        
        let gridTemplateColumns = '';
        for (let i = 0; i < columns; i++) {
            gridTemplateColumns += (i === aisleAfter ? '0.5fr ' : '1fr ');
        }
        $container.css('gridTemplateColumns', gridTemplateColumns.trim());
    }

    // Show Add Bus Modal
    $('#addBusBtn, #mobileAddBusBtn, #emptyAddBusBtn').on('click', function(e) {
        e.preventDefault();
        addBusModal.show();
        initializeSeatLayout();
    });

    // Core layout generation function
    function generateSeatLayout(containerId, rows, columns, aisleAfter, includeBackRow, backRowSeats, existingLayout = null) {
        const $container = $('#' + containerId);
        if ($container.length === 0) return;

        $container.empty();
        updateGridLayout(containerId, columns, aisleAfter);
        
        let layout = [];
        let totalSeats = 0;

        // Main rows
        for (let r = 0; r < rows; r++) {
            const row = [];
            for (let c = 0; c < columns; c++) {
                if (c === aisleAfter) {
                    const $aisle = $('<div>', {
                        class: 'seat-item aisle',
                        text: ' '
                    });
                    $container.append($aisle);
                    row.push({ seat: 'AISLE', status: 'aisle' });
                    continue;
                }

                const effectiveCol = c > aisleAfter ? c - 1 : c;
                const seatNumber = `${String.fromCharCode(65 + effectiveCol)}${r + 1}`;
                
                const $seat = $('<div>', {
                    class: 'seat-item',
                    text: seatNumber,
                    'data-seat': seatNumber,
                    'data-row': r,
                    'data-col': effectiveCol
                });

                // Default to unselected (unavailable) for new layout, selected (available) for edit
                let isSelected = existingLayout ? false : true;
                if (existingLayout && existingLayout.layout) {
                    const rowData = existingLayout.layout[r];
                    if (rowData && rowData[c] && rowData[c].status === 'available') {
                        isSelected = true;
                    } else if (rowData && rowData[c] && rowData[c].status === 'booked') {
                        $seat.addClass('booked');
                        isSelected = false; // Booked seats can't be changed here
                    }
                }

                if (isSelected) {
                    $seat.addClass('selected');
                }

                // Make seats selectable unless booked
                if (!$seat.hasClass('booked')) {
                    $seat.on('click', function() {
                        $(this).toggleClass('selected');
                        updateLayoutData(containerId === 'seatLayoutContainer');
                    });
                }

                $container.append($seat);
                row.push({ seat: seatNumber, status: isSelected ? 'available' : 'unavailable' });
                if (isSelected) totalSeats++;
            }
            layout.push(row);
        }

        // Back row
        if (includeBackRow) {
            const $backRowLabel = $('<div>', {
                class: 'w-100 text-center mt-3 mb-2',
                text: 'Back Row',
                css: {
                    'grid-column': '1 / -1'
                }
            });
            $container.append($backRowLabel);

            const $backRowContainer = $('<div>', {
                class: 'd-flex justify-content-center w-100',
                css: {
                    'grid-column': '1 / -1'
                }
            });
            $container.append($backRowContainer);

            const backRow = [];
            for (let c = 0; c < backRowSeats; c++) {
                const seatNumber = `${String.fromCharCode(65 + c)}${rows + 1}`;
                
                const $seat = $('<div>', {
                    class: 'seat-item mx-1',
                    text: seatNumber,
                    'data-seat': seatNumber,
                    'data-row': rows,
                    'data-col': c
                });

                let isSelected = existingLayout ? false : true;
                if (existingLayout && existingLayout.layout) {
                    const backRowData = existingLayout.layout[rows];
                    if (backRowData && backRowData[c] && backRowData[c].status === 'available') {
                        isSelected = true;
                    } else if (backRowData && backRowData[c] && backRowData[c].status === 'booked') {
                        $seat.addClass('booked');
                        isSelected = false;
                    }
                }

                if (isSelected) {
                    $seat.addClass('selected');
                }

                if (!$seat.hasClass('booked')) {
                    $seat.on('click', function() {
                        $(this).toggleClass('selected');
                        updateLayoutData(containerId === 'seatLayoutContainer');
                    });
                }

                $backRowContainer.append($seat);
                backRow.push({ seat: seatNumber, status: isSelected ? 'available' : 'unavailable' });
                if (isSelected) totalSeats++;
            }
            layout.push(backRow);
        }

        updateSeatCount(containerId, totalSeats);
        return layout;
    }

    // Update layout data
    function updateLayoutData(isAddModal = true) {
        const prefix = isAddModal ? '' : 'edit_';
        const rows = parseInt($('#' + prefix + 'rowsInput').val()) || 6;
        const columns = parseInt($('#' + prefix + 'columnsInput').val()) || 5;
        const aisleAfter = parseInt($('#' + prefix + 'aisleAfterInput').val()) || 2;
        const includeBackRow = $('#' + prefix + 'includeBackRow').prop('checked');
        const backRowSeats = parseInt($('#' + prefix + 'backRowSeatsInput').val()) || 5;
        const containerId = isAddModal ? 'seatLayoutContainer' : 'edit_seatLayoutContainer';

        const $seats = $('#' + containerId).find('.seat-item:not(.aisle)');
        let layout = [];
        let totalSeats = 0;

        for (let r = 0; r < (includeBackRow ? rows + 1 : rows); r++) {
            const row = [];
            const rowSeats = $seats.filter(function() {
                return parseInt($(this).data('row')) === r;
            });
            
            if (r < rows) {
                for (let c = 0; c < columns; c++) {
                    if (c === aisleAfter) {
                        row.push({ seat: 'AISLE', status: 'aisle' });
                        continue;
                    }
                    const effectiveCol = c > aisleAfter ? c - 1 : c;
                    const seatNumber = `${String.fromCharCode(65 + effectiveCol)}${r + 1}`;
                    
                    const $seat = rowSeats.filter(function() {
                        return $(this).data('seat') === seatNumber;
                    });
                    
                    const isSelected = $seat.hasClass('selected') || false;
                    const isBooked = $seat.hasClass('booked') || false;
                    const status = isBooked ? 'booked' : (isSelected ? 'available' : 'unavailable');
                    
                    row.push({ seat: seatNumber, status: status });
                    if (status === 'available') totalSeats++;
                }
            } else if (includeBackRow) {
                for (let c = 0; c < backRowSeats; c++) {
                    const seatNumber = `${String.fromCharCode(65 + c)}${r + 1}`;
                    
                    const $seat = rowSeats.filter(function() {
                        return $(this).data('seat') === seatNumber;
                    });
                    
                    const isSelected = $seat.hasClass('selected') || false;
                    const isBooked = $seat.hasClass('booked') || false;
                    const status = isBooked ? 'booked' : (isSelected ? 'available' : 'unavailable');
                    
                    row.push({ seat: seatNumber, status: status });
                    if (status === 'available') totalSeats++;
                }
            }
            layout.push(row);
        }

        const layoutData = {
            rows, 
            columns, 
            aisleAfterColumn: aisleAfter,
            includeBackRow, 
            backRowSeats, 
            layout, 
            totalSeats: totalSeats
        };

        $('#' + prefix + 'layoutData').val(JSON.stringify(layoutData));
        $('#' + prefix + 'total_seats').val(totalSeats);
        $('#' + prefix + 'selectedSeatsCount').text(totalSeats);
    }
    
    // Helper function to update seat count
    function updateSeatCount(containerId, count) {
        const prefix = containerId === 'seatLayoutContainer' ? '' : 'edit_';
        $('#' + prefix + 'selectedSeatsCount').text(count);
        $('#' + prefix + 'total_seats').val(count);
    }

    // Initialization functions
    function initializeSeatLayout() {
        const rows = parseInt($('#rowsInput').val()) || 6;
        const columns = parseInt($('#columnsInput').val()) || 5;
        const aisleAfter = parseInt($('#aisleAfterInput').val()) || 2;
        const includeBackRow = $('#includeBackRow').prop('checked');
        const backRowSeats = parseInt($('#backRowSeatsInput').val()) || 5;
        
        generateSeatLayout('seatLayoutContainer', rows, columns, aisleAfter, includeBackRow, backRowSeats);
        updateLayoutData(true);
    }

    function initializeEditSeatLayout(layoutData = null) {
        const rows = parseInt($('#edit_rowsInput').val()) || 6;
        const columns = parseInt($('#edit_columnsInput').val()) || 5;
        const aisleAfter = parseInt($('#edit_aisleAfterInput').val()) || 2;
        const includeBackRow = $('#edit_includeBackRow').prop('checked');
        const backRowSeats = parseInt($('#edit_backRowSeatsInput').val()) || 5;
        
        generateSeatLayout('edit_seatLayoutContainer', rows, columns, aisleAfter, includeBackRow, backRowSeats, layoutData);
        updateLayoutData(false);
    }

    // Event listeners for real-time updates
    function setupRealtimeListeners(prefix = '') {
        const inputs = ['rowsInput', 'columnsInput', 'aisleAfterInput', 'backRowSeatsInput'];
        
        // Set up change listeners for numeric inputs
        $.each(inputs, function(index, id) {
            $('#' + prefix + id).on('change', function() {
                if (prefix === 'edit_') {
                    initializeEditSeatLayout();
                } else {
                    initializeSeatLayout();
                }
            });
        });
        
        // Set up change listener for checkbox
        $('#' + prefix + 'includeBackRow').on('change', function() {
            // Show/hide back row seats input based on checkbox state
            $('#' + prefix + 'backRowSeatsContainer').toggle($(this).prop('checked'));
            
            if (prefix === 'edit_') {
                initializeEditSeatLayout();
            } else {
                initializeSeatLayout();
            }
        });

        const containerId = prefix === '' ? 'seatLayoutContainer' : 'edit_seatLayoutContainer';

        // Select all seats button
        $('#' + prefix + 'selectAllSeatsBtn').on('click', function() {
            $('#' + containerId).find('.seat-item:not(.aisle):not(.booked)').addClass('selected');
            updateLayoutData(prefix === '');
        });

        // Deselect all seats button
        $('#' + prefix + 'deselectAllSeatsBtn').on('click', function() {
            $('#' + containerId).find('.seat-item:not(.aisle):not(.booked)').removeClass('selected');
            updateLayoutData(prefix === '');
        });
    }

    // Setup listeners for both add and edit modals
    setupRealtimeListeners('');
    setupRealtimeListeners('edit_');

    // Edit Bus Handling
    $('.edit-bus-btn').on('click', function() {
        const busId = $(this).data('bus-id');
        $('#editBusForm').attr('action', `/edit-bus/${busId}/`);
        $('#edit_bus_id').val(busId);
        
        $.ajax({
            url: `/get_bus/${busId}/`,
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                $('#edit_bus_number').val(data.bus_number);
                $('#edit_bus_type').val(data.bus_type);
                $('#edit_driver').val(data.driver || '');
                $('#edit_staff').val(data.staff || '');
                $('#edit_isActive').prop('checked', data.is_active);
                
                if ($('#edit_commission').length) {
                    $('#edit_commission').val(data.rate || 0);
                }
                
                if ($('#edit_transportation').length && data.transportation_company) {
                    $('#edit_transportation').val(data.transportation_company);
                }
                
                // Set features checkboxes
                $('#edit_features_container .form-check-input').each(function() {
                    $(this).prop('checked', data.features.includes($(this).val()));
                });
                
                // Set layout configuration
                const layout = JSON.parse(data.layout || '{}');
                $('#edit_rowsInput').val(layout.rows || 6);
                $('#edit_columnsInput').val(layout.columns || 5);
                $('#edit_aisleAfterInput').val(layout.aisleAfterColumn || 2);
                $('#edit_includeBackRow').prop('checked', layout.includeBackRow !== false);
                $('#edit_backRowSeatsInput').val(layout.backRowSeats || 5);
                $('#edit_backRowSeatsContainer').toggle(layout.includeBackRow !== false);
                
                // Show bus image if available
                if (data.bus_image) {
                    $('#current_image_preview').html(`
                        <img src="${data.bus_image}" alt="Current Bus Image" class="img-thumbnail" style="max-height: 100px">
                        <div class="small text-muted mt-1">Current image</div>
                    `);
                } else {
                    $('#current_image_preview').empty();
                }
                
                initializeEditSeatLayout(layout);
                editBusModal.show();
            },
            error: function(xhr, status, error) {
                console.error('Error fetching bus data:', error);
                alert('Failed to load bus data. Please try again.');
            }
        });
    });

    // Form submission
    $('#editBusForm').on('submit', function(e) {
        e.preventDefault();
        updateLayoutData(false);
        
        const formData = new FormData(this);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            success: function(data) {
                if (data.success) {
                    editBusModal.hide();
                    window.location.href = data.redirect;
                } 
            },
            error: function(xhr, status, error) {
                console.error('Error updating bus:', error);
                alert('Failed to update bus. Please try again.');
            }
        });
    });



    // Delete handling
$('.delete-bus-btn').on('click', function(e) {
    e.preventDefault();
    
    const busId = $(this).data('bus-id');
    const busNumber = $(this).data('bus-number');
    
    $('#deleteBusNumber').text(busNumber);
    $('#deleteBusForm').attr('action', `/delete-bus/${busId}/`);
    
    // Show the confirmation modal
    deleteConfirmModal.show();
});

    // Delete Bus Form submission
    {% comment %} $('#deleteBusForm').on('submit', function(e) {
        e.preventDefault();
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            success: function(data) {
                if (data.success) {
                    deleteConfirmModal.hide();
                    window.location.href = data.redirect || window.location.href;
                } 
            },
            error: function(xhr, status, error) {
                console.error('Error deleting bus:', error);
                alert('Failed to delete bus. Please try again.');
            }
        });
    }); {% endcomment %}

    // Search functionality
    $('#searchBuses').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        
        $('tbody tr').each(function() {
            const busNumber = $(this).find('h6').text().toLowerCase() || '';
            const busCounter = $(this).find('td:nth-child(2)').text().toLowerCase() || '';
            const busType = $(this).find('td:nth-child(3)').text().toLowerCase() || '';
            
            const matches = 
                busNumber.includes(searchTerm) || 
                busCounter.includes(searchTerm) || 
                busType.includes(searchTerm);
                
            $(this).toggle(matches);
        });
    });

    // Toggle back row seats input based on checkbox
    $('#includeBackRow').on('change', function() {
        $('#backRowSeatsContainer').toggle($(this).prop('checked'));
    });
    
    $('#edit_includeBackRow').on('change', function() {
        $('#edit_backRowSeatsContainer').toggle($(this).prop('checked'));
    });

    // Initialize layout when page loads
    initializeSeatLayout();
});
</script>
{% endblock %}


