{% extends 'components/base.html' %}
{% load static %}

{% block title %}Bus {{ bus.bus_number|default:'Details' }} | Go Sewa{% endblock %}

{% block content %}
<div class="dashboard-container">
    <main class="dashboard-content px-3 px-md-4 py-4">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center flex-wrap mb-4 pb-2 border-bottom">
                <h3 class="h2 fw-bold text-primary"><i class="bi bi-bus-front me-2"></i>Bus {{ bus.bus_number|default:'N/A' }}</h3>
                <button onclick="history.back()" class="btn btn-outline-primary btn-sm" aria-label="Back">
                    <i class="bi bi-arrow-left me-1"></i> Back
                </button>
            </div>

            <!-- Bus Details -->
            <div class="card border-0 shadow-sm modern-card mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="h5 fw-bold text-primary"><i class="bi bi-info-circle me-2"></i>Bus Information</h5>
                </div>
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-lg-4">
                            <div class="position-relative">
                                {% if bus.bus_image %}
                                    <img src="{{ bus.bus_image.url }}" alt="Bus {{ bus.bus_number }} image" class="img-fluid w-100" style="object-fit: cover; min-height: 200px; border-radius: 12px 0 0 12px;">
                                {% else %}
                                    <div class="bg-light w-100 d-flex align-items-center justify-content-center" style="min-height: 200px; border-radius: 12px 0 0 12px;">
                                        <i class="bi bi-image text-muted fs-3"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="d-flex justify-content-start mt-2 px-3">
                                <div class="bg-gradient-primary text-white px-3 py-2 rounded-12">
                                    <i class="bi bi-tag-fill me-1"></i> {{ bus.get_bus_type_display|default:'N/A' }}
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="p-4">
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-circle bg-primary-soft p-2 me-3">
                                                <i class="bi bi-signpost text-primary fs-5"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Route</small>
                                                <span class="fw-medium">{{ schedule.route.source|default:'N/A' }} <i class="bi bi-arrow-right"></i> {{ schedule.route.destination|default:'N/A' }}</span>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-circle bg-primary-soft p-2 me-3">
                                                <i class="bi bi-person-fill text-primary fs-5"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Driver</small>
                                                <span class="fw-medium">{{ bus.driver.full_name|default:'Not Assigned' }}</span>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-circle bg-primary-soft p-2 me-3">
                                                <i class="bi bi-people-fill text-primary fs-5"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Staff</small>
                                                <span class="fw-medium">{{ bus.staff.full_name|default:'Not Assigned' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-circle bg-primary-soft p-2 me-3">
                                                <i class="bi bi-cash-stack text-primary fs-5"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Price per Seat</small>
                                                <span class="fw-medium">NPR {{ schedule.price|floatformat:2|default:'0.00' }}</span>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-circle bg-primary-soft p-2 me-3">
                                                <i class="bi bi-currency-dollar text-primary fs-5"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Total Amount</small>
                                                <span class="fw-medium">NPR {{ total_amount|floatformat:2|default:'0.00' }}</span>
                                            </div>
                                        </div>
                                        <div class="d-flex mb-3">
                                            <div class="icon-circle bg-primary-soft p-2 me-3">
                                                <i class="bi bi-stars text-primary fs-5"></i>
                                            </div>
                                            <div>
                                                <small class="text-muted d-block">Features</small>
                                                <div class="mt-1">
                                                    {% for feature in bus.features.all %}
                                                        <span class="badge bg-primary bg-opacity-10 text-primary me-1 mb-1">
                                                            <i class="bi bi-check-circle me-1"></i> {{ feature.name|default:feature }}
                                                        </span>
                                                    {% empty %}
                                                        <span class="badge bg-gray-200 text-muted">No features</span>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-light p-3 mt-3">
                        <div class="row g-3 text-center">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="icon-circle bg-success bg-opacity-10 p-2 me-2">
                                        <i class="bi bi-grid-3x3 text-success fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Total Seats </small>
                                        <span class="fw-bold">{{ bus.total_seats|default:0 }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="icon-circle bg-primary bg-opacity-10 p-2 me-2">
                                        <i class="bi bi-check-circle text-primary fs-5"></i>
                                    </div>
                                    <div class="text-center">
                                        <small class="text-muted d-block">Available</small>
                                        <span class="fw-bold seat-count-available">{{ schedule.available_seats|default:0 }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="icon-circle bg-danger bg-opacity-10 p-2 me-2">
                                        <i class="bi bi-x-circle text-danger fs-5"></i>
                                    </div>
                                    <div class="text-center">
                                        <small class="text-muted d-block">Booked</small>
                                        <span class="fw-bold seat-count-booked">{{ total_seat_booked|default:0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seat Layout -->
            <div class="card border-0 shadow-sm modern-card">
                <div class="card-header bg-white py-3">
                    <h5 class="h5 fw-bold text-primary"><i class="bi bi-grid-3x3-gap me-2"></i>Seat Layout</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <div class="bg-light p-3 rounded-12">
                                <div class="d-flex flex-wrap gap-3 justify-content-center">
                                    <div class="d-flex align-items-center">
                                        <div class="seat-indicator available me-2"></div>
                                        <span><i class="bi bi-check-circle text-success me-1"></i> Available</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="seat-indicator booked me-2"></div>
                                        <span><i class="bi bi-x-circle text-danger me-1"></i> Booked</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="seat-indicator aisle me-2"></div>
                                        <span><i class="bi bi-arrows-expand text-muted me-1"></i> Removed</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <span>Click a seat for details</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Driver's Cabin -->
                    <div class="mb-4 text-center">
                        <div class="drivers-cabin mx-auto mb-3 d-flex align-items-center justify-content-center">
                            <i class="bi bi-person-vcard me-1"></i> Driver
                        </div>
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="bus-door me-3">
                                <i class="bi bi-door-open text-muted fs-5"></i>
                            </div>
                            <div class="bus-front-indicator d-flex align-items-center justify-content-center">
                                <i class="bi bi-arrow-right me-1"></i> Front
                            </div>
                        </div>
                    </div>

                    <!-- Seat Layout -->
                    <div class="seat-layout mx-auto" style="max-width: 650px;">
                        <div class="overflow-auto">
                            {% for row in seat_layout %}
                                <div class="seat-row d-flex justify-content-center gap-2 mb-2">
                                    {% for seat in row %}
                                        {% if seat.status == 'aisle' %}
                                            <div class="seat aisle d-flex align-items-center justify-content-center"
                                                 data-seat="{{ seat.seat }}"
                                                 data-bus-id="{{ bus.id|default:0 }}"
                                                 data-schedule-id="{{ schedule.id|default:0 }}"
                                                 data-status="aisle"
                                                 role="button"
                                                 aria-label="Removed seat">
                                                <i class="bi bi-arrows-expand text-muted"></i>
                                            </div>
                                        {% else %}
                                            <div class="seat {{ seat.status }} position-relative"
                                                 data-seat="{{ seat.seat }}"
                                                 data-bus-id="{{ bus.id|default:0 }}"
                                                 data-schedule-id="{{ schedule.id|default:0 }}"
                                                 data-booking-id="{{ seat.booking_id|default:0 }}"
                                                 data-status="{{ seat.status }}"
                                                 role="button"
                                                 aria-label="Seat {{ seat.seat }} - {{ seat.status }}"
                                                 {% if seat.status == 'booked' and seat.user %}
                                                     data-bs-toggle="tooltip"
                                                     data-bs-placement="top"
                                                     data-bs-title="Booked by: {{ seat.user|default:'N/A' }}"
                                                 {% endif %}>
                                                {{ seat.seat }}
                                                {% if seat.status == 'booked' %}
                                                    <i class="bi bi-lock-fill seat-icon"></i>
                                                {% else %}
                                                    <i class="bi bi-check-circle seat-icon"></i>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% empty %}
                                <div class="text-center py-4">
                                    <i class="bi bi-exclamation-circle text-muted fs-3 mb-2"></i>
                                    <p class="text-muted">No seat layout available</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Booking Details Modal -->
            <div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 rounded-12 shadow-sm">
                        <div class="modal-header bg-white border-0">
                            <h5 class="modal-title fw-bold text-primary" id="bookingDetailsModalLabel">
                                <i class="bi bi-ticket-perforated me-2"></i> Seat Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="d-flex flex-column gap-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-ticket-perforated text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Booking Number</small>
                                        <span id="modal-ticket-id" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-person-fill text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Passenger</small>
                                        <span id="modal-user" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-telephone-fill text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Phone Number</small>
                                        <span id="modal-user-phone" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-bus-front-fill text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Bus Number</small>
                                        <span id="modal-bus-number" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-signpost-split-fill text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Route</small>
                                        <span id="modal-route" class="fw-medium"></span>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-geo-alt-fill text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Boarding Point</small>
                                        <span id="modal-boarding-point" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-check2-circle text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Booking Status</small>
                                        <span id="modal-booking-status" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-chair text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Seat</small>
                                        <span id="modal-seats" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-calendar-check-fill text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Booked At</small>
                                        <span id="modal-booked-at" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-123 text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Total Seats Booked</small>
                                        <span id="modal-total-seat" class="fw-medium"></span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle bg-primary-soft p-2 me-3">
                                        <i class="bi bi-cash text-primary fs-5"></i>
                                    </div>
                                    <div>
                                        <small class="text-muted d-block">Total Price</small>
                                        <span class="fw-medium">NPR <span id="modal-total-price"></span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal" aria-label="Close modal">
                                <i class="bi bi-x me-1"></i> Close
                            </button>
                            <button type="button" class="btn btn-primary btn-sm d-none" id="btnPrintTicket" aria-label="Print ticket">
                                <i class="bi bi-printer me-1"></i> Print Ticket
                            </button>
                            <button type="button" class="btn btn-warning btn-sm d-none" id="btnToggleAvailability" aria-label="Toggle seat availability">
                                <i class="bi bi-arrow-left-right me-1"></i> <span id="toggleText"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSRF Token Meta Tag -->
            <meta name="csrf-token" content="{{ csrf_token }}">
        </div>
    </main>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Modern Card Styling */
.modern-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-radius: 12px !important;
}
.modern-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
}

/* Gradient for bus type badge */
.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
}

/* Seat styles */
.seat {
    width: 45px;
    height: 45px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    cursor: pointer;
}
.seat.available {
    background-color: #28a745;
    color: white;
}
.seat.booked {
    background-color: #dc3545;
    color: white;
}
.seat.aisle {
    background-color: transparent;
    border: none;
    box-shadow: none;
    cursor: pointer;
}
.seat:hover:not(.aisle) {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.seat.aisle:hover {
    background-color: #e9ecef;
}
.seat-icon {
    position: absolute;
    bottom: -4px;
    right: -4px;
    font-size: 0.75rem;
    background: white;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.seat.available .seat-icon {
    color: #28a745;
}
.seat.booked .seat-icon {
    color: #dc3545;
}

.seat-indicator {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}
.seat-indicator.available {
    background-color: #28a745;
}
.seat-indicator.booked {
    background-color: #dc3545;
}
.seat-indicator.aisle {
    background-color: #e9ecef;
}

/* Driver's cabin */
.drivers-cabin {
    width: 120px;
    height: 40px;
    background-color: #e9ecef;
    border-radius: 8px 8px 0 0;
    color: #6c757d;
    font-size: 0.875rem;
    transition: all 0.3s ease;
}
.drivers-cabin:hover {
    background-color: #d3d7db;
}

.bus-door {
    color: #6c757d;
    font-size: 1.5rem;
    transition: color 0.3s ease;
}
.bus-door:hover {
    color: #343a40;
}

.bus-front-indicator {
    background-color: #e9ecef;
    border-radius: 20px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    color: #6c757d;
    transition: all 0.3s ease;
}
.bus-front-indicator:hover {
    background-color: #d3d7db;
}

.seat-layout {
    padding: 1.25rem;
    background-color: #f8f9fa;
    border-radius: 12px;
}

/* Buttons */
.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
}
.btn-primary, .btn-outline-primary, .btn-warning {
    font-weight: 500;
    transition: all 0.3s ease;
}
.btn-primary:hover, .btn-outline-primary:hover, .btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Icon Circle Hover */
.icon-circle {
    transition: background-color 0.3s ease;
}
.icon-circle:hover {
    background-color: #e6f0fa;
}

/* Toast */
.toast {
    z-index: 1055;
}

/* Rounded corners */
.rounded-12 {
    border-radius: 12px !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container-fluid {
        padding: 0 10px;
    }
    .card-body {
        padding: 1.25rem;
    }
    .seat {
        width: 40px;
        height: 40px;
        font-size: 0.75rem;
    }
    .seat-icon {
        width: 14px;
        height: 14px;
        font-size: 0.6rem;
    }
    .drivers-cabin {
        width: 100px;
        height: 35px;
        font-size: 0.75rem;
    }
    .col-lg-4 {
        position: relative;
    }
    .bg-gradient-primary {
        margin-top: 10px;
        width: auto;
    }
    .bg-light.p-3.mt-3 {
        margin-top: 20px !important;
    }
}

@media (max-width: 576px) {
    .card-header {
        padding: 1rem;
    }
    h3 {
        font-size: 1.25rem;
    }
    h5 {
        font-size: 0.875rem;
    }
    .seat {
        width: 35px;
        height: 35px;
        font-size: 0.7rem;
    }
    .seat-row {
        gap: 4px !important;
    }
    .seat-layout {
        padding: 0.5rem;
    }
    .drivers-cabin {
        width: 90px;
        height: 30px;
        font-size: 0.7rem;
    }
}

@media (min-width: 768px) {
    .dashboard-content {
        margin-left: 220px;
        width: calc(100% - 220px);
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Utility to get CSRF token from meta tag
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

$(document).ready(function() {
    // Initialize Bootstrap modals and tooltips
    const modal = new bootstrap.Modal($('#bookingDetailsModal')[0]);
    $('[data-bs-toggle="tooltip"]').tooltip({ trigger: 'hover' });

    // Toast function
    function showToast(title, message, type) {
        const toastHtml = `
            <div class="toast position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-${type} text-white">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            </div>
        `;
        const toast = $(toastHtml).appendTo('body');
        new bootstrap.Toast(toast[0], { delay: 5000 }).show();
        toast.on('hidden.bs.toast', function() { $(this).remove(); });
    }

    // Handle seat clicks
    $('.seat').on('click', function() {
        const $seat = $(this);
        const seatNumber = $seat.data('seat');
        const busId = $seat.data('bus-id');
        const scheduleId = $seat.data('schedule-id');
        const bookingId = $seat.data('booking-id');
        const status = $seat.data('status');
        const isBooked = status === 'booked';
        const isAisle = status === 'aisle';
        const isToggleable = status === 'available' || status === 'unavailable';

        // Show loading state
        const originalContent = $seat.html();
        $seat.html('<div class="spinner-border spinner-border-sm text-light" role="status"><span class="visually-hidden">Loading...</span></div>');

        // Fetch booking details only for booked seats
        $.ajax({
            url: isBooked && bookingId ? `/booking-details/${bookingId}/` : null,
            method: isBooked && bookingId ? 'GET' : null,
            success: function(data) {
                // Default data for unbooked seats
                const seatData = isBooked && bookingId ? data : {
                    id: 'N/A',
                    user: 'N/A',
                    user_phone: 'N/A',
                    bus_number: '{{ bus.bus_number|default:"N/A" }}',
                    source: '{{ schedule.route.source|default:"N/A" }}',
                    destination: '{{ schedule.route.destination|default:"N/A" }}',
                    boarding_point: '{{ schedule.boarding_point|default:"N/A" }}',
                    booking_status: isAisle ? 'Removed' : (isBooked ? 'Booked' : (status === 'available' ? 'Available' : 'Unavailable')),
                    seat: [seatNumber],
                    booked_at: 'N/A',
                    total_seat: 1,
                    total_price: 0
                };

                // Populate modal
                $('#modal-ticket-id').text(seatData.id || 'N/A');
                $('#modal-user').text(seatData.user || 'N/A');
                $('#modal-user-phone').text(seatData.user_phone || 'N/A');
                $('#modal-bus-number').text(seatData.bus_number || 'N/A');
                $('#modal-route').text(`${seatData.source || 'N/A'} → ${seatData.destination || 'N/A'}`);
                $('#modal-boarding-point').text(seatData.boarding_point || 'N/A');

                const statusConfig = {
                    confirmed: { class: 'text-success', icon: 'bi-check-circle-fill' },
                    pending: { class: 'text-warning', icon: 'bi-hourglass-split' },
                    cancelled: { class: 'text-danger', icon: 'bi-x-circle-fill' },
                    booked: { class: 'text-danger', icon: 'bi-x-circle-fill' },
                    available: { class: 'text-success', icon: 'bi-check-circle-fill' },
                    unavailable: { class: 'text-warning', icon: 'bi-dash-circle-fill' },
                    removed: { class: 'text-muted', icon: 'bi-arrows-expand' }
                }[seatData.booking_status.toLowerCase()] || { class: 'text-muted', icon: 'bi-question-circle-fill' };
                $('#modal-booking-status').html(`<span class="${statusConfig.class}"><i class="bi ${statusConfig.icon} me-1"></i>${seatData.booking_status}</span>`);

                $('#modal-seats').text(seatData.seat?.join(', ') || seatNumber);
                const bookingDate = seatData.booked_at && seatData.booked_at !== 'N/A' ? new Date(seatData.booked_at).toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }) : 'N/A';
                $('#modal-booked-at').text(bookingDate);
                $('#modal-total-seat').text(seatData.total_seat || '1');
                $('#modal-total-price').text(parseFloat(seatData.total_price || 0).toFixed(2));

                // Configure buttons
                $('#btnPrintTicket').toggleClass('d-none', seatData.booking_status.toLowerCase() !== 'confirmed');

                const $toggleBtn = $('#btnToggleAvailability');
                const $toggleText = $('#toggleText');

                if (!isToggleable) {
                    $toggleBtn.addClass('d-none'); // Hide toggle for booked or aisle seats
                } else {
                    $toggleBtn.removeClass('d-none');
                    if (status === 'available') {
                        $toggleText.text('Make Unavailable');
                        $toggleBtn.data({
                            status: 'unavailable',
                            seat_number: seatNumber,
                            schedule_id: scheduleId
                        });
                    } else if (status === 'unavailable') {
                        $toggleText.text('Make Available');
                        $toggleBtn.data({
                            status: 'available',
                            seat_number: seatNumber,
                            schedule_id: scheduleId
                        });
                    }
                }

                $seat.html(originalContent);
                modal.show();
            },
            error: function(xhr) {
                $seat.html(originalContent);
                showToast('Error', `Failed to load details for seat ${seatNumber}.`, 'danger');
            }
        });
    });

    // Toggle seat availability
    $('#btnToggleAvailability').on('click', function() {
        const $btn = $(this);
        const status = $btn.data('status');
        const seatNumber = $btn.data('seat_number');
        const scheduleId = $btn.data('schedule_id');
        const csrfToken = getCsrfToken();

        if (!csrfToken) {
            showToast('Error', 'CSRF token not found.', 'danger');
            return;
        }

        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1" role="status"></span>Processing...');

        const requestData = {
            schedule_id: scheduleId,
            seat_number: seatNumber,
            status: status
        };
        console.log('Sending data:', requestData); // Debug log

        $.ajax({
            url: '{% url "change_bus_availability" %}',
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                if (response.success) {
                    const $seat = $(`.seat[data-seat="${seatNumber}"]`);
                    $seat.removeClass('booked available aisle unavailable').addClass(response.status === 'available' ? 'available' : 'unavailable');
                    $seat.data('status', response.status === 'available' ? 'available' : 'unavailable');

                    if (response.status === 'available') {
                        $seat.html(`${seatNumber}<i class="bi bi-check-circle seat-icon"></i>`);
                        $seat.removeAttr('data-booking-id data-bs-toggle data-bs-title');
                    } else {
                        $seat.html(`${seatNumber}<i class="bi bi-dash-circle seat-icon"></i>`);
                        $seat.removeAttr('data-booking-id data-bs-toggle data-bs-title');
                    }

                    modal.hide();
                    showToast('Success', `Seat ${seatNumber} is now ${response.status === 'available' ? 'available' : 'unavailable'}.`, 'success');

                    // Update seat counts
                    const availableSeats = parseInt($('.seat.available').length);
                    const totalSeats = parseInt('{{ bus.total_seats|default:0 }}');
                    const bookedSeats = $('.seat.booked').length;
                    const unavailableSeats = $('.seat.unavailable').length;
                    const remainingAvailable = totalSeats - bookedSeats - unavailableSeats;

                    $('.seat-count-available').text(remainingAvailable);
                    $('.seat-count-booked').text(bookedSeats);
                } else {
                    showToast('Error', response.message || 'Failed to update seat status.', 'danger');
                }
            },
            error: function(xhr) {
                console.log('Error response:', xhr.responseText); // Debug log
                showToast('Error', `Failed to update seat ${seatNumber}.`, 'danger');
            },
            complete: function() {
                $btn.prop('disabled', false).html(`<i class="bi bi-arrow-left-right me-1"></i> <span id="toggleText">${status === 'available' ? 'Make Unavailable' : 'Make Available'}</span>`);
            }
        });
    });

    // Print ticket
    $('#btnPrintTicket').on('click', function() {
        const $modalContent = $('#bookingDetailsModal .modal-body').clone();
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Print Ticket</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
                        .icon-circle { display: none; }
                        .text-muted { color: #6c757d !important; }
                        .fw-medium { font-weight: 500; }
                    </style>
                </head>
                <body>
                    <h3 class="text-primary">Ticket Details</h3>
                    ${$modalContent[0].outerHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    });

    // Responsive seat sizing
    function adjustSeatSize() {
        const $layout = $('.seat-layout');
        const $row = $('.seat-row');
        if (!$layout.length || !$row.length) return;

        const containerWidth = $layout.width();
        const seatCount = $row.children().length;

        if (containerWidth < 400 && seatCount > 5) {
            $('.seat').css({ width: '30px', height: '30px', fontSize: '0.6rem' });
        } else {
            $('.seat').css({ width: '45px', height: '45px', fontSize: '0.875rem' });
        }
    }

    adjustSeatSize();
    $(window).on('resize', adjustSeatSize);
});
</script>
{% endblock %}