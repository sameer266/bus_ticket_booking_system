{% extends 'components/base.html' %}
{% block title %}Bus Schedules | Go Sewa{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row g-0">
        <!-- Main Content -->
        <main class="col-md-12 ms-sm-auto px-md-4 py-4 main-content">

              <!-- Mesage --> 
              {% if messages %}
              {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2" role="alert">
                      {{ message }}
                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
              {% endfor %}
          {% endif %}
          
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
                <h1 class="h2 fw-bold">
                    <i class="bi bi-clock-history me-2 text-primary"></i>Bus Schedules
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button id="addScheduleBtn" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                        <i class="bi bi-plus-lg me-1"></i> New Schedule
                    </button>
                </div>
            </div>

            <!-- Mobile Action Button -->
            <div class="d-flex d-md-none mb-3">
                <button id="mobileAddScheduleBtn" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                    <i class="bi bi-plus-lg me-1"></i> Add New Schedule
                </button>
            </div>

            <!-- Enhanced Date Selector -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-calendar-date me-2"></i>Select Date
                    </h5>
                </div>
                <div class="card-body">
                    <form id="dateFilterForm" method="GET" action="{% url 'schedule_list' %}">
                        <div class="row g-3 align-items-center">
                            <div class="col-12 col-md-6">
                                <div class="date-picker-wrapper position-relative">
                                    <input type="date" id="customDatePicker" name="date" class="form-control" 
                                           aria-label="Select specific date" value="{{ selected_date }}">
                                    <label for="customDatePicker" class="position-absolute top-0 end-0 p-2 text-primary cursor-pointer">
                                        <i class="bi bi-calendar3"></i>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="date-selector d-flex flex-wrap gap-2 justify-content-md-end">
                                    {% for i in "0123"|make_list %}
                                    {% with day_offset=forloop.counter0 %}
                                    <button type="button" class="btn date-btn {% if forloop.first and not selected_date_str %}btn-primary active{% else %}btn-outline-secondary{% endif %}" 
                                            data-date-offset="{{ day_offset }}">
                                        <span class="date-label">
                                            {% if day_offset == 0 %}Today
                                            {% elif day_offset == 1 %}Tomorrow
                                            {% elif day_offset == 2 %}In 2 days
                                            {% else %}In 3 days{% endif %}
                                        </span>
                                        <span class="date-value d-block small"></span>
                                    </button>
                                    {% endwith %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Enhanced Search and Filter Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-body py-3">
                    <form id="filterForm" method="GET" action="{% url 'schedule_list' %}">
                        <input type="hidden" name="date" id="hiddenDateField" value="{{ selected_date }}">
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0" id="searchSchedules" 
                                           name="search" placeholder="Search routes, buses, times..." value="{{ search_query }}">
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <select class="form-select" id="routeFilter" name="route">
                                    <option value="">All Routes</option>
                                    {% for route in all_routes %}
                                    <option value="{{ route.id }}" {% if route_id == route.id %}selected{% endif %}>
                                        {{ route.source }} → {{ route.destination }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <select class="form-select" id="timeFilter" name="time_range">
                                    <option value="">All Times</option>
                                    <option value="ongoing" {% if time_range == 'ongoing' %}selected{% endif %}>Ongoing</option>
                                    <option value="upcoming" {% if time_range == 'upcoming' %}selected{% endif %}>Upcoming</option>
                                    <option value="finished" {% if time_range == 'finished' %}selected{% endif %}>Completed</option>
                                </select>
                            </div>
                            <div class="col-12 d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-funnel me-1"></i> Apply Filters
                                </button>
                                <a href="{% url 'schedule_list' %}" class="btn btn-outline-secondary ms-2">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Schedules List Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 flex-wrap">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-calendar-check me-2"></i>
                        <span id="scheduleListTitle">
                            {% if selected_date == today_date %}Today's Schedules
                            {% elif selected_date == tomorrow_date %}Tomorrow's Schedules
                            {% else %}Schedules for {{ selected_date|date:"F d, Y" }}{% endif %}
                        </span>
                    </h5>
                    <div class="schedule-count badge bg-primary rounded-pill py-2 px-3 mt-2 mt-md-0">
                        <span id="scheduleCounter">{{ schedules|length }}</span> schedules found
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Route</th>
                                    <th>Bus</th>
                                    {% if user.role == 'admin' %}
                                    <th>Company</th>
                                    {% endif %}
                                    <th>Status</th>
                                    <th class="d-none d-md-table-cell">Departure</th>
                                    <th class="d-none d-md-table-cell">Arrival</th>
                                    <th class="d-none d-md-table-cell">Price</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                {% for schedule in schedules %}
                                <tr class="schedule-row animate__animated animate__fadeIn" 
                                    data-schedule-id="{{ schedule.id }}" 
                                    data-schedule-date="{{ schedule.departure_time|date:'Y-m-d' }}"
                                    data-route-id="{{ schedule.route.id }}"
                                    data-status="{{ schedule.status }}"
                                    data-search-text="{{ schedule.route.source|lower }} {{ schedule.route.destination|lower }} {{ schedule.bus.bus_number|lower }} {{ schedule.departure_time|date:'h:i A'|lower }} {{ schedule.arrival_time|date:'h:i A'|lower }}">
                                    <td class="ps-3">
                                        <div class="d-flex align-items-center">
                                            <div class="route-icon rounded bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="bi bi-signpost-2"></i>
                                            </div>
                                            <div>
                                                <a href="{% url 'bus_details' schedule.id %}" class="text-decoration-none fw-medium"> 
                                                    <h6 class="mb-0">{{ schedule.route.source }} → {{ schedule.route.destination }}</h6> 
                                                </a>
                                                <small class="text-muted d-md-none">
                                                    {{ schedule.departure_time|date:"h:i A" }} - {{ schedule.arrival_time|date:"h:i A" }}
                                                </small>
                                                <small class="text-muted d-md-none d-block">NPR {{ schedule.price }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="d-inline-block">{{ schedule.bus.bus_number }}</span>
                                        <small class="text-muted d-block d-md-inline ms-md-2">{{ schedule.bus.bus_type }}</small>
                                    </td>
                                    {% if user.role == "admin" %}
                                    <td>{{ schedule.transportation_company }}</td>
                                    {% endif %}
                                    <td>
                                        <span class="badge rounded-pill {% if schedule.status == 'ongoing' %}bg-success{% elif schedule.status == 'upcoming' %}bg-primary{% else %}bg-secondary{% endif %}">
                                            <i class="bi {% if schedule.status == 'ongoing' %}bi-play-circle{% elif schedule.status == 'upcoming' %}bi-clock{% else %}bi-check-circle{% endif %} me-1"></i>
                                            {{ schedule.status|title }}
                                        </span>
                                    </td>
                                    <td class="d-md-table-cell">
                                        <div class="departure-time">
                                            <span class="fw-medium">{{ schedule.departure_time|date:"h:i A" }}</span>
                                            <div class="small text-muted">{{ schedule.departure_time|date:"M d, Y" }}</div>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <div class="arrival-time">
                                            <span class="fw-medium">{{ schedule.arrival_time|date:"h:i A" }}</span>
                                            <div class="small text-muted">{{ schedule.arrival_time|date:"M d, Y" }}</div>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <span class="fw-medium">NPR {{ schedule.price }}</span>
                                    </td>
                                    <td class="text-end pe-3">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button class="btn btn-sm btn-outline-warning edit-schedule-btn" 
                                                    data-schedule-id="{{ schedule.id }}"
                                                    data-route-id="{{ schedule.route.id }}"
                                                    data-bus-id="{{ schedule.bus.id }}"
                                                    data-departure="{{ schedule.departure_time|date:'c' }}"
                                                    data-arrival="{{ schedule.arrival_time|date:'c' }}"
                                                    data-price="{{ schedule.price }}"
                                                    data-status="{{ schedule.status }}"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editScheduleModal">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-schedule-btn" 
                                                    data-schedule-id="{{ schedule.id }}"
                                                    data-route="{{ schedule.route.source }} → {{ schedule.route.destination }}"
                                                    data-bus="{{ schedule.bus.bus_number }} ({{ schedule.bus.bus_type }})"
                                                    data-time="{{ schedule.departure_time|date:'h:i A' }} - {{ schedule.arrival_time|date:'h:i A' }}"
                                                    data-delete-url="{% url 'schedule_delete' schedule.id %}"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteConfirmModal">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr id="no-schedules-row">
                                    <td colspan="{% if user.role == 'admin' %}8{% else %}7{% endif %}" class="text-center py-5">
                                        <div class="py-4">
                                            <i class="bi bi-calendar-x display-5 text-muted d-block mb-3"></i>
                                            <h5 class="text-muted">No schedules found</h5>
                                            <p class="text-muted">Add a new bus schedule or adjust filters</p>
                                            <button id="emptyAddScheduleBtn" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                                                <i class="bi bi-plus-circle me-1"></i> Add Schedule
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScheduleModalLabel"><i class="bi bi-clock-history me-2 text-primary"></i>Add New Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'schedule_list' %}" id="addScheduleForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Route <span class="text-danger">*</span></label>
                            <select class="form-select" name="route" required>
                                <option value="">-- Select Route --</option>
                                {% for route in all_routes %}
                                <option value="{{ route.id }}">{{ route.source }} → {{ route.destination }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Bus <span class="text-danger">*</span></label>
                            <select class="form-select" name="bus" required>
                                <option value="">-- Select Bus --</option>
                                {% for bus in all_buses %}
                                <option value="{{ bus.id }}">{{ bus.bus_number }} - {{ bus.bus_type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Departure Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="datetime-local" class="form-control" name="departure_time" id="add_departure_time" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Arrival Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                                <input type="datetime-local" class="form-control" name="arrival_time" id="add_arrival_time" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Price (NPR) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NPR</span>
                                <input type="number" class="form-control" name="price" placeholder="e.g., 500" min="0" step="1" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addScheduleForm" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> Add Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScheduleModalLabel"><i class="bi bi-clock-history me-2 text-primary"></i>Edit Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="" id="editScheduleForm">
                    {% csrf_token %}
                    <input type="hidden" name="schedule_id" id="edit_schedule_id">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Route <span class="text-danger">*</span></label>
                            <select class="form-select" name="route" id="edit_route" required>
                                <option value="">-- Select Route --</option>
                                {% for route in all_routes %}
                                <option value="{{ route.id }}">{{ route.source }} → {{ route.destination }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Bus <span class="text-danger">*</span></label>
                            <select class="form-select" name="bus" id="edit_bus" required>
                                <option value="">-- Select Bus --</option>
                                {% for bus in all_buses %}
                                <option value="{{ bus.id }}">{{ bus.bus_number }} - {{ bus.bus_type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Departure Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="datetime-local" class="form-control" name="departure_time" id="edit_departure_datetime" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Arrival Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                                <input type="datetime-local" class="form-control" name="arrival_time" id="edit_arrival_datetime" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Price (NPR) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NPR</span>
                                <input type="number" class="form-control" name="price" id="edit_price" min="0" step="1" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Status</label>
                            <select class="form-select" name="status" id="edit_status">
                                <option value="ongoing">Ongoing</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="finished">Finished</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editScheduleForm" class="btn btn-warning">
                    <i class="bi bi-pencil-square me-1"></i> Update Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this schedule?</p>
                <div class="alert alert-light border p-3 mt-2">
                    <p class="mb-1 fw-bold" id="deleteScheduleRoute"></p>
                    <p class="mb-1" id="deleteScheduleBus"></p>
                    <p class="mb-0" id="deleteScheduleTime"></p>
                </div>
                <p class="text-muted mt-3">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i> Delete Schedule
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .route-icon {
        transition: all 0.3s ease;
        font-size: 1.25rem;
    }
    
    tr:hover .route-icon {
        transform: scale(1.05);
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow-x: auto;
    }
    
    .schedule-count {
        font-weight: 500;
    }
    
    .input-group-text {
        background-color: #f8f9fa;
    }
    
    .animate__fadeIn {
        animation-duration: 0.4s;
    }
    
    .modal-content {
        border-radius: 12px;
    }
    
    .modal-header, .modal-footer {
        border-color: #e9ecef;
    }
    
    .btn:focus, .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1060;
    }
    
    @media (max-width: 767.98px) {
        .main-content {
            margin-top: 0 !important;
        }
        
        .date-btn {
            flex: 1 1 calc(50% - 8px);
            max-width: calc(50% - 8px);
        }
        
        .table td, .table th {
            font-size: 0.875rem;
        }
        
        .route-icon {
            width: 35px !important;
            height: 35px !important;
            font-size: 1rem;
        }
        
        .modal-fullscreen-md-down .modal-content {
            border-radius: 0;
            height: 100%;
        }
    }
    
    @media (max-width: 575.98px) {
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .date-btn {
            flex: 1 1 100%;
            max-width: 100%;
        }
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    .modal { z-index: 1055; }
    .modal-backdrop { z-index: 1050; }
    
    .is-invalid {
        border-color: #dc3545 !important;
    }
    
    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 0.875rem;
    }
    
    .is-invalid ~ .invalid-feedback {
        display: block;
    }

    @media (min-width: 992px) {
        .main-content {
            margin-left: 100px;
            width: calc(100% - 100px);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap components
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].forEach(el => new bootstrap.Tooltip(el));
    
    const addScheduleModal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
    const editScheduleModal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

    // Toast notification utility
    function showToast(message, type = 'success') {
        const toastContainer = document.querySelector('.toast-container') || 
            document.body.appendChild(Object.assign(document.createElement('div'), { className: 'toast-container' }));
        
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }



    // Date handling utilities
    function formatDateForInput(date) {
        return date.toISOString().split('T')[0];
    }

    function formatDateForDisplay(date) {
        return date.toLocaleDateString('en-US', { month: 'short', day: '2-digit' });
    }

    function formatDatetimeLocal(date) {
        return date.toISOString().slice(0, 16);
    }

    // Update date buttons
    function updateDateButtons() {
        const today = new Date();
        const dateButtons = document.querySelectorAll('.date-btn');
        const selectedDate = document.getElementById('customDatePicker').value;

        dateButtons.forEach(button => {
            const offset = parseInt(button.dataset.dateOffset);
            const buttonDate = new Date(today);
            buttonDate.setDate(buttonDate.getDate() + offset);

            const dateValue = button.querySelector('.date-value');
            dateValue.textContent = formatDateForDisplay(buttonDate);
            
            const buttonDateStr = formatDateForInput(buttonDate);
            button.dataset.date = buttonDateStr;

            button.classList.toggle('btn-primary', buttonDateStr === selectedDate);
            button.classList.toggle('active', buttonDateStr === selectedDate);
            button.classList.toggle('btn-outline-secondary', buttonDateStr !== selectedDate);
        });
    }

    // Submit date filter
    function submitDateFilter(dateStr) {
        const dateInput = document.getElementById('customDatePicker');
        const hiddenDateField = document.getElementById('hiddenDateField');
        
        dateInput.value = dateStr;
        hiddenDateField.value = dateStr;
        document.getElementById('dateFilterForm').submit();
    }

    // Date picker and button handlers
    document.getElementById('customDatePicker').addEventListener('change', function() {
        submitDateFilter(this.value);
    });

    document.querySelector('label[for="customDatePicker"]').addEventListener('click', () => {
        document.getElementById('customDatePicker').showPicker();
    });

    document.querySelectorAll('.date-btn').forEach(button => {
        button.addEventListener('click', () => submitDateFilter(button.dataset.date));
    });

    // Initialize date buttons
    updateDateButtons();

    // Form validation
    function validateScheduleForm(formId) {
        const form = document.getElementById(formId);
        form.addEventListener('submit', function(e) {
            const departureInput = this.querySelector('[name="departure_time"]');
            const arrivalInput = this.querySelector('[name="arrival_time"]');
            const priceInput = this.querySelector('[name="price"]');

            let isValid = true;

            // Validate departure and arrival times
            if (departureInput && arrivalInput) {
                const departureTime = new Date(departureInput.value);
                const arrivalTime = new Date(arrivalInput.value);

                if (arrivalTime <= departureTime) {
                    isValid = false;
                    arrivalInput.classList.add('is-invalid');
                    showToast('Arrival time must be after departure time', 'danger');
                } else {
                    arrivalInput.classList.remove('is-invalid');
                }
            }

            // Validate price
            if (priceInput && (parseFloat(priceInput.value) <= 0)) {
                isValid = false;
                priceInput.classList.add('is-invalid');
                showToast('Price must be greater than 0', 'danger');
            } else {
                priceInput.classList.remove('is-invalid');
            }

            if (!isValid) {
                e.preventDefault();
            }
        });
    }

    validateScheduleForm('addScheduleForm');
    validateScheduleForm('editScheduleForm');

    // Add schedule modal
    document.querySelectorAll('#addScheduleBtn, #mobileAddScheduleBtn, #emptyAddScheduleBtn').forEach(btn => {
        btn.addEventListener('click', () => {
            const now = new Date();
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);

            document.getElementById('add_departure_time').value = formatDatetimeLocal(oneHourLater);
            document.getElementById('add_arrival_time').value = formatDatetimeLocal(twoHoursLater);
        });
    });

    // Edit schedule modal
    document.querySelectorAll('.edit-schedule-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const data = this.dataset;
            
            document.getElementById('edit_schedule_id').value = data.scheduleId;
            document.getElementById('edit_route').value = data.routeId;
            document.getElementById('edit_bus').value = data.busId;
            document.getElementById('edit_departure_datetime').value = formatDatetimeLocal(new Date(data.departure));
            document.getElementById('edit_arrival_datetime').value = formatDatetimeLocal(new Date(data.arrival));
            document.getElementById('edit_price').value = data.price;
            document.getElementById('edit_status').value = data.status;

            const form = document.getElementById('editScheduleForm');
            form.action = `/schedules/edit/${data.scheduleId}/`;
        });
    });

    // Delete schedule modal
    let currentDeleteUrl = '';
    document.querySelectorAll('.delete-schedule-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const data = this.dataset;
            
            document.getElementById('deleteScheduleRoute').textContent = data.route;
            document.getElementById('deleteScheduleBus').textContent = `Bus: ${data.bus}`;
            document.getElementById('deleteScheduleTime').textContent = `Time: ${data.time}`;
            currentDeleteUrl = data.deleteUrl;
            document.getElementById('confirmDeleteBtn').dataset.scheduleId = data.scheduleId;
        });
    });

    // Handle delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        const scheduleId = this.dataset.scheduleId;
        deleteConfirmModal.hide();

        $.ajax({
            url: currentDeleteUrl,
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function(response) {
                document.querySelector(`.schedule-row[data-schedule-id="${scheduleId}"]`).remove();
                
                const visibleRows = document.querySelectorAll('.schedule-row:not([style*="display: none"])').length;
                document.getElementById('scheduleCounter').textContent = visibleRows;
                document.getElementById('no-schedules-row').style.display = visibleRows === 0 ? 'table-row' : 'none';
                
                showToast('Schedule deleted successfully', 'success');
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON?.detail || 'Failed to delete schedule';
                showToast(errorMsg, 'danger');
            }
        });
    });

    // Filter schedules
    function filterSchedules() {
        const searchInput = document.getElementById('searchSchedules');
        const routeFilter = document.getElementById('routeFilter');
        const timeFilter = document.getElementById('timeFilter');
        
        const searchTerm = searchInput.value.toLowerCase();
        const selectedRouteId = routeFilter.value;
        const selectedTimeRange = timeFilter.value;

        const scheduleRows = document.querySelectorAll('.schedule-row');
        let visibleCount = 0;

        scheduleRows.forEach(row => {
            const searchText = row.dataset.searchText.toLowerCase();
            const routeId = row.dataset.routeId;
            const status = row.dataset.status;

            const matchesSearch = searchText.includes(searchTerm);
            const matchesRoute = !selectedRouteId || routeId === selectedRouteId;
            const matchesTime = !selectedTimeRange || status === selectedTimeRange;

            if (matchesSearch && matchesRoute && matchesTime) {
                row.style.display = 'table-row';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('scheduleCounter').textContent = visibleCount;
        document.getElementById('no-schedules-row').style.display = visibleCount === 0 ? 'table-row' : 'none';
    }

    // Initialize filters
    document.getElementById('searchSchedules').addEventListener('input', filterSchedules);
    document.getElementById('routeFilter').addEventListener('change', filterSchedules);
    document.getElementById('timeFilter').addEventListener('change', filterSchedules);
    filterSchedules();

    // Responsive layout
    function handleResponsiveLayout() {
        const dateBtns = document.querySelectorAll('.date-btn');
        const isMobile = window.innerWidth < 576;

        dateBtns.forEach(btn => {
            const label = btn.querySelector('.date-label');
            const originalText = label.getAttribute('data-original-text') || label.textContent;
            label.setAttribute('data-original-text', originalText);

            if (isMobile) {
                if (originalText.includes('Today')) label.textContent = 'Today';
                else if (originalText.includes('Tomorrow')) label.textContent = 'Tomorrow';
                else if (originalText.includes('2 days')) label.textContent = '+2 days';
                else if (originalText.includes('3 days')) label.textContent = '+3 days';
            } else {
                label.textContent = originalText;
            }
        });
    }

    handleResponsiveLayout();
    window.addEventListener('resize', handleResponsiveLayout);
});
</script>
{% endblock %}