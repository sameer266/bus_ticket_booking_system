{% extends 'components/base.html' %}
{% block title %}Bus Schedules | Go Sewa{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row g-0">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebarMenu">
            {% include 'components/sidebar.html' %}
        </div>
        <!-- Main Content -->
        <main class="mt-5 col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4 main-content">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
                <h1 class="h2 fw-bold">
                    <i class="bi bi-clock-history me-2 text-primary"></i>Bus Schedules
                </h1>

                <div class="btn-toolbar mb-2 mb-md-0">
                    <button id="addScheduleBtn" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-plus-lg me-1"></i> New Schedule
                    </button>
                </div>
            </div>

               <!-- Messages --> 
               {% if messages %}
               {% for message in messages %}
                   <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2" role="alert">
                       {{ message }}
                       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                   </div>
               {% endfor %}
           {% endif %}

           
            
            <!-- Mobile Action Button -->
            <div class="d-flex d-md-none mb-3">
                <button id="mobileAddScheduleBtn" class="btn btn-primary w-100">
                    <i class="bi bi-plus-lg me-1"></i> Add New Schedule
                </button>
            </div>
            
           <!-- Enhanced Date Selector -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3">
        <h5 class="mb-0 fw-bold text-primary">
            <i class="bi bi-calendar-date me-2"></i>Select Date
        </h5>
    </div>
    <div class="card-body">
        <form id="dateFilterForm" method="GET" action="{% url 'schedule_list' %}">
            <div class="row g-3 align-items-center">
                <div class="col-12 col-md-6">
                    <div class="date-picker-wrapper position-relative">
                        <input type="date" id="customDatePicker" name="date" class="form-control" 
                               aria-label="Select specific date" value="{{ selected_date }}">
                        <label for="customDatePicker" class="position-absolute top-0 end-0 p-2 text-primary cursor-pointer">
                            <i class="bi bi-calendar3"></i>
                        </label>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="date-selector d-flex flex-wrap gap-2 justify-content-md-end">
                        {% for i in "0123"|make_list %}
                        {% with day_offset=forloop.counter0 %}
                        <button type="button" class="btn date-btn {% if forloop.first and not selected_date_str %}btn-primary active{% else %}btn-outline-secondary{% endif %}" 
                                data-date-offset="{{ day_offset }}">
                            <span class="date-label">
                                {% if day_offset == 0 %}
                                Today
                                {% elif day_offset == 1 %}
                                Tomorrow
                                {% elif day_offset == 2 %}
                                In 2 days
                                {% else %}
                                In 3 days
                            {% endif %}
                            </span>
                            <span class="date-value d-block small"></span>
                        </button>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

            
            <!-- Enhanced Search and Filter Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-body py-3">
                    <form id="filterForm" method="GET" action="{% url 'schedule_list' %}">
                        <input type="hidden" name="date" id="hiddenDateField" value="{{ selected_date }}">
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0" id="searchSchedules" 
                                           name="search" placeholder="Search routes, buses, times..." value="{{ search_query }}">
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <select class="form-select" id="routeFilter" name="route">
                                    <option value="">All Routes</option>
                                    {% for route in all_routes %}
                                    <option value="{{ route.id }}" {% if route_id == route.id %}selected{% endif %}>
                                        {{ route.source }} → {{ route.destination }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <select class="form-select" id="timeFilter" name="time_range">
                                    <option value="">All Times</option>
                                    <option value="ongoing" >Ongoing</option>
                                    <option value="upcomming" >Upcomming</option>
                                    <option value="finished" >Completed</option>
                                </select>
                                   
                            </div>
                            <div class="col-12 d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-funnel me-1"></i> Apply Filters
                                </button>
                                <a href="{% url 'schedule_list' %}" class="btn btn-outline-secondary ms-2">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Schedules List Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 flex-wrap">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-calendar-check me-2"></i>
                        <span id="scheduleListTitle">
                            {% if selected_date == today_date %}Today's Schedules
                            {% elif selected_date == tomorrow_date %}Tomorrow's Schedules
                            {% else %}Schedules for {{ selected_date|date:"F d, Y" }}{% endif %}
                        </span>
                    </h5>
                    <div class="schedule-count badge bg-primary rounded-pill py-2 px-3 mt-2 mt-md-0">
                        <span id="scheduleCounter">{{ schedules|length }}</span> schedules found
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Route</th>
                                    <th>Bus</th>
                                    {% if user.role == 'admin' %}
                                    <th>Company</th>
                                    {% endif %}
                                    <th>Status</th>
                                    <th class="d-none d-md-table-cell">Departure</th>
                                    <th class="d-none d-md-table-cell">Arrival</th>
                                    <th class="d-none d-md-table-cell">Price</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                {% for schedule in schedules %}
                                <tr class="schedule-row animate__animated animate__fadeIn" 
                                    data-schedule-id="{{ schedule.id }}" 
                                    data-schedule-date="{{ schedule.departure_time|date:'Y-m-d' }}"
                                    data-route-id="{{ schedule.route.id }}"
                                    data-departure-hour="{{ schedule.departure_time|date:'H' }}"
                                    data-search-text="{{ schedule.route.source|lower }} {{ schedule.route.destination|lower }} {{ schedule.bus.bus_number|lower }} {{ schedule.departure_time|date:'h:i A'|lower }} {{ schedule.arrival_time|date:'h:i A'|lower }}">
                                    <td class="ps-3">
                                        <div class="d-flex align-items-center">
                                            <div class="route-icon rounded bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                <i class="bi bi-signpost-2"></i>
                                            </div>
                                            <div>
                                               <a href="{% url 'bus_details' schedule.id %}" class="text-decoration-none fw-medium"> 
                                                   <h6 class="mb-0">{{ schedule.route.source }} → {{ schedule.route.destination }}</h6> 
                                               </a>
                                                <small class="text-muted d-md-none">
                                                    {{ schedule.departure_time|date:"h:i A" }} - {{ schedule.arrival_time|date:"h:i A" }}
                                                </small>
                                                <small class="text-muted d-md-none d-block">NPR {{ schedule.price }}</small>
                                            </div>
                                        </div>
                                    </td>

                                    <td>
                                        <span class="d-inline-block">{{ schedule.bus.bus_number }}</span>
                                        <small class="text-muted d-block d-md-inline ms-md-2">{{ schedule.bus.bus_type }}</small>
                                    </td>

                                    {% if user.role == "admin" %}
                                    <td>
                                        <span class="d-inline-block">{{ schedule.transportation_company }}</span>
                                        <small class="text-muted d-block d-md-inline ms-md-2">{{ schedule.transportation_company }}</small>
                                    
                                    </td>
                                        {% endif %}
                                        

                                       
                                        <td>
                                        <span class="badge rounded-pill {% if schedule.status == 'ongoing' %}bg-success{% elif schedule.status == 'upcomming' %}bg-primary{% else %}bg-secondary{% endif %}">
                                            <i class="bi {% if schedule.status == 'ongoing' %}bi-play-circle{% elif schedule.status == 'upcomming' %}bi-clock{% else %}bi-check-circle{% endif %} me-1"></i>
                                            {{ schedule.status|title }}
                                        </span>
                                    </td>



                                  

                                    <td class="d-md-table-cell">
                                        <div class="departure-time">
                                            <span class="fw-medium">{{ schedule.departure_time|date:"h:i A" }}</span>
                                            <div class="small text-muted">{{ schedule.departure_time|date:"M d, Y" }}</div>
                                        </div>
                                    </td>

                                    <td class="d-none d-md-table-cell">
                                        <div class="arrival-time">
                                            <span class="fw-medium">{{ schedule.arrival_time|date:"h:i A" }}</span>
                                            <div class="small text-muted">{{ schedule.arrival_time|date:"M d, Y" }}</div>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <span class="fw-medium">NPR {{ schedule.price }}</span>
                                    </td>
                                    <td class="text-end pe-3">
                                        <div class="d-flex justify-content-end gap-2">
                                            <a href="{% url 'schedule_edit' schedule.id %}" class="btn btn-sm btn-outline-warning edit-schedule-btn">
                                                <i class="bi bi-pencil-square"></i>
                                            </a>
                                            <a href="{% url 'schedule_delete' schedule.id %}" class="btn btn-sm btn-outline-danger delete-schedule-btn" 
                                               data-bs-toggle="tooltip" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr id="no-schedules-row">
                                    <td colspan="6" class="text-center py-5">
                                        <div class="py-4">
                                            <i class="bi bi-calendar-x display-5 text-muted d-block mb-3"></i>
                                            <h5 class="text-muted">No schedules found</h5>
                                            <p class="text-muted">Add a new bus schedule or adjust filters</p>
                                            <button id="emptyAddScheduleBtn" class="btn btn-primary mt-2">
                                                <i class="bi bi-plus-circle me-1"></i> Add Schedule
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScheduleModalLabel"><i class="bi bi-clock-history me-2 text-primary"></i>Add New Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'schedule_list' %}" id="addScheduleForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Route <span class="text-danger">*</span></label>
                            <select class="form-select" name="route" required>
                                <option value="">-- Select Route --</option>
                                {% for route in all_routes %}
                                <option value="{{ route.id }}">{{ route.source }} → {{ route.destination }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Bus <span class="text-danger">*</span></label>
                            <select class="form-select" name="bus" required>
                                <option value="">-- Select Bus --</option>
                                {% for bus in all_buses %}
                                <option value="{{ bus.id }}">{{ bus.bus_number }} - {{ bus.get_bus_type_display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Departure Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="datetime-local" class="form-control" name="departure_time" id="add_departure_time" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Arrival Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                                <input type="datetime-local" class="form-control" name="arrival_time" id="add_arrival_time" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Price (NPR) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NPR</span>
                                <input type="number" class="form-control" name="price" placeholder="e.g., 500" min="0" step="1" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addScheduleForm" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> Add Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScheduleModalLabel"><i class="bi bi-clock-history me-2 text-primary"></i>Edit Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="" id="editScheduleForm">
                    {% csrf_token %}
                    <input type="hidden" name="schedule_id" id="edit_schedule_id">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Route <span class="text-danger">*</span></label>
                            <select class="form-select" name="route" id="edit_route" required>
                                <option value="">-- Select Route --</option>
                                {% for route in all_routes %}
                                <option value="{{ route.id }}">{{ route.source }} → {{ route.destination }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Bus <span class="text-danger">*</span></label>
                            <select class="form-select" name="bus" id="edit_bus" required>
                                <option value="">-- Select Bus --</option>
                                {% for bus in all_buses %}
                                <option value="{{ bus.id }}">{{ bus.bus_number }} - {{ bus.get_bus_type_display }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Departure Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="datetime-local" class="form-control" name="departure_time" id="edit_departure_datetime" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Arrival Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                                <input type="datetime-local" class="form-control" name="arrival_time" id="edit_arrival_datetime" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Price (NPR) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NPR</span>
                                <input type="number" class="form-control" name="price" id="edit_price" min="0" step="1" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Status</label>
                            <select class="form-select" name="status" id="edit_status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editScheduleForm" class="btn btn-warning">
                    <i class="bi bi-pencil-square me-1"></i> Update Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this schedule?</p>
                <div class="alert alert-light border p-3 mt-2">
                    <p class="mb-1 fw-bold" id="deleteScheduleRoute"></p>
                    <p class="mb-1" id="deleteScheduleBus"></p>
                    <p class="mb-0" id="deleteScheduleTime"></p>
                </div>
                <p class="text-muted mt-3">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i> Delete Schedule
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Base styles */
    .sidebar {
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        height: 100vh;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
    }
    
    .main-content {
        background-color: #fff;
        min-height: 100vh;
    }
    
    .card {
        border: none;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Enhanced date selector styles */
    .date-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .date-btn {
        flex: 1 1 100px;
        min-width: 100px;
        text-align: center;
        padding: 8px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .date-btn:hover {
        transform: translateY(-1px);
    }
    
    .date-label {
        font-weight: 500;
    }
    
    .date-value {
        font-size: 0.75rem;
        opacity: 0.9;
    }
    
    .date-picker-wrapper {
        position: relative;
    }
    
    /* Table styling */
    .table th, .table td {
        vertical-align: middle;
        padding: 0.75rem;
    }
    
    .table th {
        font-weight: 600;
        color: #495057;
        background-color: #f8f9fa;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    .route-icon {
        transition: all 0.3s ease;
        font-size: 1.25rem;
    }
    
    tr:hover .route-icon {
        transform: scale(1.05);
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow-x: auto;
    }
    
    .schedule-count {
        font-weight: 500;
    }
    
    .input-group-text {
        background-color: #f8f9fa;
    }
    
    .animate__fadeIn {
        animation-duration: 0.4s;
    }
    
    .status-active { color: #198754; }
    .status-inactive { color: #dc3545; }
    
    .departure-time, .arrival-time {
        line-height: 1.2;
    }
    
    /* Modal styles */
    .modal-content {
        border-radius: 12px;
    }
    
    .modal-header, .modal-footer {
        background-color: #f8f9fa;
        border-color: #e9ecef;
    }
    
    /* Accessibility improvements */
    .btn:focus, .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Toast notifications */
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1060;
    }
    
    /* Skeleton loader */
    .skeleton-loader {
        background: linear-gradient(90deg, #f0f0f0 25%, #e3e3e3 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
        height: 24px;
        margin: 8px 0;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .sidebar {
            position: static;
            height: auto;
            border-right: none;
            border-bottom: 1px solid #dee2e6;
        }
        
        .main-content {
            margin-top: 0 !important;
        }
        
        .date-btn {
            flex: 1 1 calc(50% - 8px);
            max-width: calc(50% - 8px);
        }
        
        .table td, .table th {
            font-size: 0.875rem;
        }
        
        .route-icon {
            width: 35px !important;
            height: 35px !important;
            font-size: 1rem;
        }
        
        .modal-fullscreen-md-down .modal-content {
            border-radius: 0;
            height: 100%;
        }
    }
    
    @media (max-width: 575.98px) {
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .date-btn {
            flex: 1 1 100%;
            max-width: 100%;
        }
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    /* Fix z-index issues with modals */
    .modal { z-index: 1055; }
    .modal-backdrop { z-index: 1050; }
</style>
{% endblock %}


{% block extra_js %}
<script>

    
    document.addEventListener('DOMContentLoaded', function() {
        // Make calendar icon click trigger the date picker
        const calendarIcon = document.querySelector('label[for="customDatePicker"]');
        const datePicker = document.getElementById('customDatePicker');
        
        if (calendarIcon && datePicker) {
            calendarIcon.addEventListener('click', function() {
                datePicker.showPicker(); // This triggers the native date picker
            });
        }
        
        // Add any additional date button functionality here
        const dateButtons = document.querySelectorAll('.date-btn');
        dateButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                dateButtons.forEach(btn => {
                    btn.classList.remove('btn-primary', 'active');
                    btn.classList.add('btn-outline-secondary');
                });
                
                // Add active class to clicked button
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-primary', 'active');
                
                // Calculate and set the date
                const offset = parseInt(this.dataset.dateOffset);
                const date = new Date();
                date.setDate(date.getDate() + offset);
                
                // Format as YYYY-MM-DD for the input
                const formattedDate = date.toISOString().split('T')[0];
                datePicker.value = formattedDate;
                
                // Submit the form
                document.getElementById('dateFilterForm').submit();
            });
        });
    });
  




document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap components
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    if (tooltipTriggerList.length > 0) {
        [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
    }
    
    // Initialize modals
    const addScheduleModal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
    const editScheduleModal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

    // Show feedback messages
    function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        
        toastEl.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        // Add to container
        toastContainer.appendChild(toastEl);
        
        // Initialize and show toast
        const toast = new bootstrap.Toast(toastEl, {
            delay: 5000,
            autohide: true
        });
        toast.show();
        
        // Remove toast after hiding
        toastEl.addEventListener('hidden.bs.toast', function() {
            toastEl.remove();
        });
    }
    
    // Display Django messages as toasts
    {% if messages %}
    {% for message in messages %}
    showToast('{{ message }}', '{{ message.tags }}');
    {% endfor %}
    {% endif %}
    
    // Date selector logic
    function updateDateButtons() {
        const today = new Date();
        const dateButtons = document.querySelectorAll('.date-btn');
        const selectedDate = document.getElementById('customDatePicker').value;
        
        // Loop through each date button
        dateButtons.forEach(button => {
            const offset = parseInt(button.dataset.dateOffset);
            const buttonDate = new Date(today);
            buttonDate.setDate(buttonDate.getDate() + offset);
            
            // Format date for display
            const formattedDate = formatDateForDisplay(buttonDate);
            const dateValue = button.querySelector('.date-value');
            if (dateValue) {
                dateValue.textContent = formattedDate;
            }
            
            // Set button value and check if it matches selected date
            const buttonDateStr = formatDateForInput(buttonDate);
            button.dataset.date = buttonDateStr;
            
            // Reset all buttons first
            button.classList.remove('btn-primary', 'active', 'btn-outline-secondary');
            button.classList.add('btn-outline-secondary');
            
            // Highlight the selected date button
            if (buttonDateStr === selectedDate) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-primary', 'active');
            }
        });
    }
    
    // Format date as YYYY-MM-DD for input fields
    function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // Format date as MMM DD for display (e.g., Apr 09)
    function formatDateForDisplay(date) {
        const options = { month: 'short', day: '2-digit' };
        return date.toLocaleDateString('en-US', options);
    }
    
    // Update hidden date field and submit form
    function submitDateFilter(dateStr) {
        const dateInput = document.getElementById('customDatePicker');
        const hiddenDateField = document.getElementById('hiddenDateField');
        
        dateInput.value = dateStr;
        hiddenDateField.value = dateStr;
        
        // Submit the form
        document.getElementById('dateFilterForm').submit();
    }
    
    // Initialize date buttons
    updateDateButtons();
    
    // Date button click event listeners
    document.querySelectorAll('.date-btn').forEach(button => {
        button.addEventListener('click', function() {
            const dateStr = this.dataset.date;
            if (dateStr) {
                submitDateFilter(dateStr);
            }
        });
    });
    
    // Custom date picker change event
    document.getElementById('customDatePicker').addEventListener('change', function() {
        submitDateFilter(this.value);
    });
    
    // Add Schedule button click event
    const addButtons = [
        document.getElementById('addScheduleBtn'),
        document.getElementById('mobileAddScheduleBtn'),
        document.getElementById('emptyAddScheduleBtn')
    ];
    
    addButtons.forEach(btn => {
        if (btn) {
            btn.addEventListener('click', function() {
                // Set default date time values to now + 1 hour for departure
                const now = new Date();
                const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
                const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);
                
                // Format for datetime-local input
                const formatDatetimeLocal = (date) => {
                    return date.toISOString().slice(0, 16);
                };
                
                document.getElementById('add_departure_time').value = formatDatetimeLocal(oneHourLater);
                document.getElementById('add_arrival_time').value = formatDatetimeLocal(twoHoursLater);
                
                addScheduleModal.show();
            });
        }
    });
    
    
    
    // Delete Schedule button click event
    document.querySelectorAll('.delete-schedule-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const deleteUrl = this.getAttribute('href');
            
            // Get schedule details from the row
            const scheduleRow = this.closest('tr');
            if (scheduleRow) {
                const routeText = scheduleRow.querySelector('h6').textContent;
                const busText = scheduleRow.querySelector('td:nth-child(2)').textContent.trim();
                const timeText = scheduleRow.querySelector('.departure-time') ? 
                    scheduleRow.querySelector('.departure-time').textContent.trim() : 
                    scheduleRow.querySelector('td:first-child small').textContent.trim();
                
                // Update delete confirmation modal
                document.getElementById('deleteScheduleRoute').textContent = routeText;
                document.getElementById('deleteScheduleBus').textContent = `Bus: ${busText}`;
                document.getElementById('deleteScheduleTime').textContent = `Time: ${timeText}`;
                document.getElementById('confirmDeleteBtn').href = deleteUrl;
                
                // Show modal
                deleteConfirmModal.show();
            }
        });
    });
    
    // Search and filter functionality
    const searchInput = document.getElementById('searchSchedules');
    const routeFilter = document.getElementById('routeFilter');
    const timeFilter = document.getElementById('timeFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', filterSchedules);
    }
    
    if (routeFilter) {
        routeFilter.addEventListener('change', filterSchedules);
    }
    
    if (timeFilter) {
        timeFilter.addEventListener('change', filterSchedules);
    }
    
    function filterSchedules() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const selectedRouteId = routeFilter ? routeFilter.value : '';
        const selectedTimeRange = timeFilter ? timeFilter.value : '';
        
        const scheduleRows = document.querySelectorAll('.schedule-row');
        let visibleCount = 0;
        
        scheduleRows.forEach(row => {
            const searchText = row.dataset.searchText.toLowerCase();
            const routeId = row.dataset.routeId;
            const departureHour = parseInt(row.dataset.departureHour);
            
            // Determine time range
            let matchesTimeRange = true;
            if (selectedTimeRange) {
                if (selectedTimeRange === 'morning' && (departureHour < 4 || departureHour >= 12)) {
                    matchesTimeRange = false;
                } else if (selectedTimeRange === 'afternoon' && (departureHour < 12 || departureHour >= 17)) {
                    matchesTimeRange = false;
                } else if (selectedTimeRange === 'evening' && (departureHour < 17 || departureHour >= 22)) {
                    matchesTimeRange = false;
                } else if (selectedTimeRange === 'night' && (departureHour >= 4 && departureHour < 22)) {
                    matchesTimeRange = false;
                }
            }
            
            // Check if row matches all filters
            const matchesSearch = searchTerm === '' || searchText.includes(searchTerm);
            const matchesRoute = selectedRouteId === '' || routeId === selectedRouteId;
            
            if (matchesSearch && matchesRoute && matchesTimeRange) {
                row.style.display = 'table-row';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update counter and no-results message
        const counterElement = document.getElementById('scheduleCounter');
        if (counterElement) {
            counterElement.textContent = visibleCount;
        }
        
        const noResultsRow = document.getElementById('no-schedules-row');
        if (noResultsRow) {
            noResultsRow.style.display = visibleCount === 0 ? 'table-row' : 'none';
        }
    }
    
    // Form validation for add/edit schedule
    function validateScheduleForm(formId) {
        const form = document.getElementById(formId);
        
        if (form) {
            form.addEventListener('submit', function(e) {
                const departureInput = this.querySelector('[name="departure_time"]');
                const arrivalInput = this.querySelector('[name="arrival_time"]');
                
                if (departureInput && arrivalInput) {
                    const departureTime = new Date(departureInput.value);
                    const arrivalTime = new Date(arrivalInput.value);
                    
                    if (arrivalTime <= departureTime) {
                        e.preventDefault();
                        showToast('Arrival time must be after departure time', 'danger');
                        arrivalInput.classList.add('is-invalid');
                    }
                }
            });
        }
    }
    
    // Validate both forms
    validateScheduleForm('addScheduleForm');
    validateScheduleForm('editScheduleForm');
    
    // Error handling for AJAX requests
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.message);
        showToast('An error occurred. Please try again.', 'danger');
    });
    
    // Responsive design adjustments
    function handleResponsiveLayout() {
        const width = window.innerWidth;
        const dateBtns = document.querySelectorAll('.date-btn');
        
        // Adjust date buttons for mobile
        if (width < 576) {
            dateBtns.forEach(btn => {
                // Simplify labels on small screens
                const label = btn.querySelector('.date-label');
                if (label) {
                    const originalText = label.getAttribute('data-original-text') || label.textContent;
                    label.setAttribute('data-original-text', originalText);
                    
                    if (originalText.includes('Today')) {
                        label.textContent = 'Today';
                    } else if (originalText.includes('Tomorrow')) {
                        label.textContent = 'Tomorrow';
                    } else if (originalText.includes('2 days')) {
                        label.textContent = '+2 days';
                    } else if (originalText.includes('3 days')) {
                        label.textContent = '+3 days';
                    }
                }
            });
        } else {
            // Restore original labels on larger screens
            dateBtns.forEach(btn => {
                const label = btn.querySelector('.date-label');
                if (label) {
                    const originalText = label.getAttribute('data-original-text');
                    if (originalText) {
                        label.textContent = originalText;
                    }
                }
            });
        }
    }
    
    // Initialize responsive layout and listen for resize
    handleResponsiveLayout();
    window.addEventListener('resize', handleResponsiveLayout);
    
    // Initialize client-side filtering
    filterSchedules();
});
</script>
{% endblock %}