{% extends 'components/base.html' %}
{% load static %}

{% block title %}Bus Schedules | Go Sewa{% endblock %}
{% block content %}
<div class="dashboard-container">
    <main class="dashboard-content px-3 px-md-4 py-4">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom">
                <h1 class="h2 fw-bold text-primary"><i class="bi bi-clock-history me-2"></i>Bus Schedules</h1>

                {% if user.role != 'bus_admin' %}
                <button id="addScheduleBtn" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                    <i class="bi bi-plus-lg me-1"></i> New Schedule
                </button>
                {% endif %}
            </div>

            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Mobile Action Button -->
            {% if user.role != 'bus_admin' %}
            <div class="d-md-none mb-4">
                <button id="mobileAddScheduleBtn" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                    <i class="bi bi-plus-lg me-1"></i> Add New Schedule
                </button>
            </div>
            {% endif %}

            <!-- Date Selector Card -->
            <div class="card border-0 shadow-sm modern-card mb-4">
                <div class="card-header bg-white">
                    <h5 class="h5 fw-bold text-primary"><i class="bi bi-calendar-date me-2"></i>Select Date</h5>
                </div>
                <div class="card-body">
                    <form id="dateFilterForm" method="GET" action="{% url 'schedule_list' %}">
                        <div class="row g-3 align-items-center">
                            <div class="col-12 col-md-6">
                                <div class="position-relative">
                                    <input type="date" id="customDatePicker" name="date" class="form-control" value="{{ selected_date }}" aria-label="Select specific date">
                                    <label for="customDatePicker" class="position-absolute top-0 end-0 p-2 text-primary cursor-pointer">
                                        <i class="bi bi-calendar3"></i>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="d-flex flex-wrap gap-2 justify-content-md-end">
                                    {% for i in "0123"|make_list %}
                                        {% with day_offset=forloop.counter0 %}
                                            <button type="button" class="btn date-btn {% if forloop.first and not selected_date_str %}btn-primary{% else %}btn-outline-secondary{% endif %} flex-fill" data-date-offset="{{ day_offset }}">
                                                <span class="date-label">
                                                    {% if day_offset == 0 %}Today
                                                    {% elif day_offset == 1 %}Tomorrow
                                                    {% elif day_offset == 2 %}In 2 days
                                                    {% else %}In 3 days{% endif %}
                                                </span>
                                                <span class="date-value d-block small text-muted"></span>
                                            </button>
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Search and Filter Card -->
            <div class="card border-0 shadow-sm modern-card mb-4">
                <div class="card-body">
                    <form id="filterForm" method="GET" action="{% url 'schedule_list' %}">
                        <input type="hidden" name="date" id="hiddenDateField" value="{{ selected_date }}">
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0" id="searchSchedules" name="search" placeholder="Search routes, buses, times..." value="{{ search_query }}">
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <select class="form-select" id="routeFilter" name="route">
                                    <option value="">All Routes</option>
                                    {% for route in all_routes %}
                                        <option value="{{ route.id }}" {% if route_id == route.id %}selected{% endif %}>
                                            {{ route.source }} â†’ {{ route.destination }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-md-4">
                                <select class="form-select" id="timeFilter" name="time_range">
                                    <option value="">All Times</option>
                                    <option value="ongoing" {% if time_range == 'ongoing' %}selected{% endif %}>Ongoing</option>
                                    <option value="upcoming" {% if time_range == 'upcoming' %}selected{% endif %}>Upcoming</option>
                                    <option value="finished" {% if time_range == 'finished' %}selected{% endif %}>Completed</option>
                                </select>
                            </div>
                            <div class="col-12 d-flex justify-content-end gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-funnel me-1"></i> Apply Filters
                                </button>
                                <a href="{% url 'schedule_list' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-1"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Schedules List Card -->
            <div class="card border-0 shadow-sm modern-card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <h5 class="h5 fw-bold text-primary">
                            <i class="bi bi-calendar-check me-2"></i>
                            <span id="scheduleListTitle">
                                {% if selected_date == today_date %}Today's Schedules
                                {% elif selected_date == tomorrow_date %}Tomorrow's Schedules
                                {% else %}Schedules for {{ selected_date|date:"F d, Y" }}{% endif %}
                            </span>
                        </h5>
                        <span class="badge bg-primary rounded-pill py-2 px-3">
                            <span id="scheduleCounter">{{ schedules|length }}</span> schedules found
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-modern mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Route</th>
                                    <th>Bus</th>
                                    {% if user.role == 'admin' %}
                                        <th>Company</th>
                                    {% endif %}
                                    {% if request.path == '/schedules-management/' and not request.GET.date %}
                                        <th>Date</th>
                                    {% endif %}
                                    <th>Status</th>
                                    <th class="d-none d-md-table-cell">Departure</th>
                                    <th class="d-none d-md-table-cell">Arrival</th>
                                    <th class="d-none d-md-table-cell">Shift</th>
                                    <th class="d-none d-md-table-cell">Original Price</th>
                                    <th class="d-none d-md-table-cell">Sales Price</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody">
                                {% for schedule in schedules %}
                                    <tr class="schedule-row" 
                                        data-schedule-id="{{ schedule.id }}"
                                        data-schedule-date="{{ schedule.departure_time|date:'Y-m-d' }}"
                                        data-route-id="{{ schedule.route.id }}"
                                        data-status="{{ schedule.status }}"
                                        data-search-text="{{ schedule.route.source|lower }} {{ schedule.route.destination|lower }} {{ schedule.bus.bus_number|lower }} {{ schedule.departure_time|date:'h:i A'|lower }} {{ schedule.arrival_time|date:'h:i A'|lower }}">
                                        <td class="ps-3">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                    <i class="bi bi-signpost-2"></i>
                                                </div>
                                                <div>
                                                    <a href="{% url 'bus_details' schedule.id %}" class="text-decoration-none fw-medium">
                                                        {{ schedule.route.source }} <i class="bi bi-arrow-right mx-2"></i> {{ schedule.route.destination }}
                                                    </a>
                                                    <div class="text-muted d-md-none small">
                                                        {{ schedule.departure_time|date:"h:i A" }} - {{ schedule.arrival_time|date:"h:i A" }}
                                                    </div>
                                                    <div class="text-muted d-md-none small">NPR {{ schedule.price }}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ schedule.bus.bus_number }}</strong>
                                            <div class="text-muted small">{{ schedule.bus.bus_type }}</div>
                                        </td>
                                        {% if user.role == "admin" %}
                                            <td>{{ schedule.bus.transportation_company }}</td>
                                        {% endif %}
                                        {% if request.path == '/schedules-management/' and not request.GET.date %}
                                            <td>{{ schedule.departure_time|date:"d M, Y" }}</td>
                                        {% endif %}
                                        <td>
                                            <span class="badge rounded-pill {% if schedule.status == 'ongoing' %}bg-success{% elif schedule.status == 'upcoming' %}bg-primary{% else %}bg-secondary{% endif %}">
                                                <i class="bi {% if schedule.status == 'ongoing' %}bi-play-circle{% elif schedule.status == 'upcoming' %}bi-clock{% else %}bi-check-circle{% endif %} me-1"></i>
                                                {{ schedule.status|title }}
                                            </span>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            <strong>{{ schedule.departure_time|date:"h:i A" }}</strong>
                                            <div class="text-muted small">{{ schedule.departure_time|date:"M d, Y" }}</div>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            <strong>{{ schedule.arrival_time|date:"h:i A" }}</strong>
                                            <div class="text-muted small">{{ schedule.arrival_time|date:"M d, Y" }}</div>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            <span class="badge bg-secondary">
                                                {{ schedule.shift | capfirst }}
                                            </span>
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {% if schedule.sale_price %}
                                                <strong class="text-success">NPR {{ schedule.sale_price }}</strong>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            <strong>NPR {{ schedule.price }}</strong>
                                        </td>
                                        <td class="text-end pe-3">
                                            <div class="d-flex justify-content-end gap-2">
                                                <button class="btn btn-sm btn-outline-warning edit-schedule-btn" 
                                                        data-schedule-id="{{ schedule.id }}"
                                                        data-route-id="{{ schedule.route.id }}"
                                                        data-bus-id="{{ schedule.bus.id }}"
                                                        data-departure="{{ schedule.departure_time|date:'c' }}"
                                                        data-arrival="{{ schedule.arrival_time|date:'c' }}"
                                                        data-original-price="{{ schedule.sale_price|default:'' }}"
                                                        data-price="{{ schedule.price }}"
                                                        data-status="{{ schedule.status }}"
                                                        data-shift="{{ schedule.shift }}"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#editScheduleModal">
                                                    <i class="bi bi-pencil-square"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger delete-schedule-btn" 
                                                        data-schedule-id="{{ schedule.id }}"
                                                        data-route="{{ schedule.route.source }} â†’ {{ schedule.route.destination }}"
                                                        data-bus="{{ schedule.bus.bus_number }} ({{ schedule.bus.bus_type }})"
                                                        data-time="{{ schedule.departure_time|date:'h:i A' }} - {{ schedule.arrival_time|date:'h:i A' }}"
                                                        data-delete-url="{% url 'schedule_delete' schedule.id %}"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#deleteConfirmModal">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr id="no-schedules-row">
                                        <td colspan="{% if user.role == 'admin' %}9{% else %}8{% endif %}" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="bi bi-calendar-x fs-1 d-block mb-3"></i>
                                                <h5>No schedules found</h5>
                                                <p>Add a new bus schedule or adjust filters.</p>
                                                {% if user.role != 'bus_admin' %}
                                                <button id="emptyAddScheduleBtn" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                                                    <i class="bi bi-plus-circle me-1"></i> Add Schedule
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Add Schedule Modal -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header bg-white">
                {% if user.role != 'bus_admin' %}
                <h5 class="modal-title text-primary" id="addScheduleModalLabel">
                    <i class="bi bi-clock-history me-2"></i> Add New Schedule
                </h5>
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'schedule_list' %}" id="addScheduleForm">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Route <span class="text-danger">*</span></label>
                            <select class="form-select" name="route" required>
                                <option value="">-- Select Route --</option>
                                {% for route in all_routes %}
                                    <option value="{{ route.id }}">{{ route.source }} â†’ {{ route.destination }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Bus <span class="text-danger">*</span></label>
                            <select class="form-select" name="bus" required>
                                <option value="">-- Select Bus --</option>
                                {% for bus in all_buses %}
                                    <option value="{{ bus.id }}">{{ bus.bus_number }} - {{ bus.bus_type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Departure Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="datetime-local" class="form-control" name="departure_time" id="add_departure_time" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Arrival Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                                <input type="datetime-local" class="form-control" name="arrival_time" id="add_arrival_time" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Sales (NPR) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NPR</span>
                                <input type="number" class="form-control" name="sale_price" placeholder="e.g., 500" min="0" step="1" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">OriginalPrice (NPR) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NPR</span>
                                <input type="number" class="form-control" name="price" placeholder="e.g., 450" min="0" step="1" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addScheduleForm" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> Add Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1" aria-labelledby="editScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-fullscreen-md-down">
        <div class="modal-content">
            <div class="modal-header bg-white">
                <h5 class="modal-title text-primary" id="editScheduleModalLabel">
                    <i class="bi bi-clock-history me-2"></i> Edit Schedule
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="" id="editScheduleForm">
                    {% csrf_token %}
                    <input type="hidden" name="schedule_id" id="edit_schedule_id">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Route <span class="text-danger">*</span></label>
                            <select class="form-select" name="route" id="edit_route" required>
                                <option value="">-- Select Route --</option>
                                {% for route in all_routes %}
                                    <option value="{{ route.id }}">{{ route.source }} â†’ {{ route.destination }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Bus <span class="text-danger">*</span></label>
                            <select class="form-select" name="bus" id="edit_bus" required>
                                <option value="">-- Select Bus --</option>
                                {% for bus in all_buses %}
                                    <option value="{{ bus.id }}">{{ bus.bus_number }} - {{ bus.bus_type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Departure Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                                <input type="datetime-local" class="form-control" name="departure_time" id="edit_departure_datetime" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Shift <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="shift" id="edit_shift" readonly>
                                <span class="input-group-text"><i class="bi bi-hourglass-split"></i></span>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-labe
System: l fw-bold text-primary">Arrival Date & Time <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-calendar-check"></i></span>
                                <input type="datetime-local" class="form-control" name="arrival_time" id="edit_arrival_datetime" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Original Price (NPR) <span class="text-secondary">(optional)</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NPR</span>
                                <input type="number" class="form-control" name="sale_price" id="edit_sale_price" min="0" step="1" >
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary"> Sales Price (NPR) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">NPR</span>
                                <input type="number" class="form-control" name="price" id="edit_price" min="0" step="1" required>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold text-primary">Status</label>
                            <select class="form-select" name="status" id="edit_status">
                                <option value="ongoing">Ongoing</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="finished">Finished</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editScheduleForm" class="btn btn-warning">
                    <i class="bi bi-pencil-square me-1"></i> Update Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this schedule?</p>
                <div class="alert alert-light border p-3 mt-2">
                    <p class="mb-1 fw-bold" id="deleteScheduleRoute"></p>
                    <p class="mb-1" id="deleteScheduleBus"></p>
                    <p class="mb-0" id="deleteScheduleTime"></p>
                </div>
                <p class="text-muted mt-2">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                    <i class="bi bi-trash me-1"></i> Delete Schedule
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media (min-width: 768px) {
        .dashboard-container {
            margin-left: 250px;
        }
    }

    .modern-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 12px !important;
    }
    .modern-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
    }

    .table-modern th {
        background-color: #f8f9fa;
        color: #343a40;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    .table-modern tbody tr {
        transition: background-color 0.3s ease;
    }
    .table-modern tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    .table-modern td {
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }

    .badge {
        font-weight: 500;
        text-transform: capitalize;
        padding: 0.4em 0.8em;
    }

    .date-btn {
        min-width: 80px;
        text-align: center;
        transition: all 0.3s ease;
    }
    .date-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 767.98px) {
        .dashboard-content {
            margin-top: 0 !important;
        }
        .date-btn {
            flex: 1 1 calc(50% - 8px);
            max-width: calc(50% - 8px);
        }
        .table td, .table th {
            font-size: 0.875rem;
        }
        .modal-fullscreen-md-down .modal-content {
            border-radius: 0;
            height: 100%;
        }
    }

    @media (max-width: 575.98px) {
        .date-btn {
            flex: 1 1 100%;
            max-width: 100%;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    }

    .cursor-pointer {
        cursor: pointer;
    }

    .modal {
        z-index: 1055;
    }

    .modal-backdrop {
        z-index: 1050;
    }

    .is-invalid {
        border-color: #dc3545 !important;
    }

    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 0.875rem;
    }

    .is-invalid ~ .invalid-feedback {
        display: block;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Bootstrap modals
    const addScheduleModal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
    const editScheduleModal = new bootstrap.Modal(document.getElementById('editScheduleModal'));
    const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

    // Toast notification utility
    function showToast(message, type = 'success') {
        const toastContainer = $('.toast-container').length ? $('.toast-container') : 
            $('<div class="toast-container position-fixed top-0 end-0 p-3"></div>').appendTo('body');
        
        const toastEl = $(`
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `);
        
        toastContainer.append(toastEl);
        toastEl.toast({ delay: 5000 }).show();
        toastEl.on('hidden.bs.toast', function() {
            $(this).remove();
        });
    }

    // Date handling utilities
    function formatDateForInput(date) {
        return date.toISOString().split('T')[0];
    }

    function formatDateForDisplay(date) {
        return date.toLocaleDateString('en-US', { month: 'short', day: '2-digit' });
    }

    function formatDatetimeLocal(date) {
        return date.toISOString().slice(0, 16);
    }

    // Update date buttons
    function updateDateButtons() {
        const today = new Date();
        const selectedDate = $('#customDatePicker').val();

        $('.date-btn').each(function() {
            const offset = parseInt($(this).data('date-offset'));
            const buttonDate = new Date(today);
            buttonDate.setDate(buttonDate.getDate() + offset);

            $(this).find('.date-value').text(formatDateForDisplay(buttonDate));
            const buttonDateStr = formatDateForInput(buttonDate);
            $(this).data('date', buttonDateStr);

            $(this).toggleClass('btn-primary', buttonDateStr === selectedDate)
                   .toggleClass('btn-outline-secondary', buttonDateStr !== selectedDate);
        });
    }

    // Submit date filter
    function submitDateFilter(dateStr) {
        $('#customDatePicker').val(dateStr);
        $('#hiddenDateField').val(dateStr);
        $('#dateFilterForm').submit();
    }

    // Date picker and button handlers
    $('#customDatePicker').on('change', function() {
        submitDateFilter($(this).val());
    });

    $('label[for="customDatePicker"]').on('click', () => {
        $('#customDatePicker')[0].showPicker();
    });

    $('.date-btn').on('click', function() {
        submitDateFilter($(this).data('date'));
    });

    // Initialize date buttons
    updateDateButtons();

    // Form validation
    function validateScheduleForm(formId) {
        $(`#${formId}`).on('submit', function(e) {
            const departureInput = $(this).find('[name="departure_time"]');
            const arrivalInput = $(this).find('[name="arrival_time"]');
            const originalPriceInput = $(this).find('[name="sale_price"]');
            const priceInput = $(this).find('[name="price"]');

            let isValid = true;

            if (departureInput.length && arrivalInput.length) {
                const departureTime = new Date(departureInput.val());
                const arrivalTime = new Date(arrivalInput.val());

                if (arrivalTime <= departureTime) {
                    isValid = false;
                    arrivalInput.addClass('is-invalid');
                    showToast('Arrival time must be after departure time', 'danger');
                } else {
                    arrivalInput.removeClass('is-invalid');
                }
            }

            if (originalPriceInput.length && (parseFloat(originalPriceInput.val()) <= 0)) {
                isValid = false;
                originalPriceInput.addClass('is-invalid');
                showToast('Original price must be greater than 0', 'danger');
            } else {
                originalPriceInput.removeClass('is-invalid');
            }

            if (priceInput.length && (parseFloat(priceInput.val()) <= 0)) {
                isValid = false;
                priceInput.addClass('is-invalid');
                showToast('Price must be greater than 0', 'danger');
            } else {
                priceInput.removeClass('is-invalid');
            }

            if (!isValid) {
                e.preventDefault();
            }
        });
    }

    validateScheduleForm('addScheduleForm');
    validateScheduleForm('editScheduleForm');

    // Add schedule modal
    $('#addScheduleBtn, #mobileAddScheduleBtn, #emptyAddScheduleBtn').on('click', function() {
        const now = new Date();
        const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
        const twoHoursLater = new Date(now.getTime() + 2 * 60 * 60 * 1000);

        $('#add_departure_time').val(formatDatetimeLocal(oneHourLater));
        $('#add_arrival_time').val(formatDatetimeLocal(twoHoursLater));
        $('#addScheduleForm')[0].reset(); // Reset form to clear previous values
    });

    // Edit schedule modal
    $('.edit-schedule-btn').on('click', function() {
        const data = $(this).data();
        
        $('#edit_schedule_id').val(data.scheduleId);
        $('#edit_route').val(data.routeId);
        $('#edit_bus').val(data.busId);
        $('#edit_departure_datetime').val(formatDatetimeLocal(new Date(data.departure)));
        $('#edit_arrival_datetime').val(formatDatetimeLocal(new Date(data.arrival)));
        $('#edit_sale_price').val(data.originalPrice || '');
        $('#edit_price').val(data.price);
        $('#edit_status').val(data.status);
        $('#edit_shift').val(data.shift || ''); // Updated to use shift

        $('#editScheduleForm').attr('action', `/schedules/edit/${data.scheduleId}/`);
    });

    // Delete schedule modal
    let currentDeleteUrl = '';
    $('.delete-schedule-btn').on('click', function() {
        const data = $(this).data();
        
        $('#deleteScheduleRoute').text(data.route);
        $('#deleteScheduleBus').text(`Bus: ${data.bus}`);
        $('#deleteScheduleTime').text(`Time: ${data.time}`);
        currentDeleteUrl = data.deleteUrl;
        $('#confirmDeleteBtn').data('schedule-id', data.scheduleId);
    });

    // Handle delete confirmation
    $('#confirmDeleteBtn').on('click', function() {
        const scheduleId = $(this).data('schedule-id');
        
        $.ajax({
            url: currentDeleteUrl,
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function(response) {
                $(`.schedule-row[data-schedule-id="${scheduleId}"]`).remove();
                const visibleRows = $('.schedule-row:visible').length;
                $('#scheduleCounter').text(visibleRows);
                $('#no-schedules-row').toggle(visibleRows === 0);
                showToast('Schedule deleted successfully', 'success');
                deleteConfirmModal.hide();
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON?.detail || 'Failed to delete schedule';
                showToast(errorMsg, 'danger');
                deleteConfirmModal.hide();
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
            }
        });
    });

    // Filter schedules
    function filterSchedules() {
        const searchTerm = $('#searchSchedules').val().toLowerCase();
        const selectedRouteId = $('#routeFilter').val();
        const selectedTimeRange = $('#timeFilter').val();

        let visibleCount = 0;

        $('.schedule-row').each(function() {
            const $row = $(this);
            const searchText = $row.data('search-text').toLowerCase();
            const routeId = $row.data('route-id');
            const status = $row.data('status');

            const matchesSearch = searchText.includes(searchTerm);
            const matchesRoute = !selectedRouteId || routeId == selectedRouteId;
            const matchesTime = !selectedTimeRange || status === selectedTimeRange;

            if (matchesSearch && matchesRoute && matchesTime) {
                $row.show();
                visibleCount++;
            } else {
                $row.hide();
            }
        });

        $('#scheduleCounter').text(visibleCount);
        $('#no-schedules-row').toggle(visibleCount === 0);
    }

    $('#searchSchedules').on('input', filterSchedules);
    $('#routeFilter').on('change', filterSchedules);
    $('#timeFilter').on('change', filterSchedules);

    filterSchedules();

    // Responsive layout
    function handleResponsiveLayout() {
        const isMobile = $(window).width() < 576;
        $('.date-btn').each(function() {
            const $label = $(this).find('.date-label');
            const originalText = $label.data('original-text') || $label.text();
            $label.data('original-text', originalText);

            if (isMobile) {
                if (originalText.includes('Today')) $label.text('Today');
                else if (originalText.includes('Tomorrow')) $label.text('Tomorrow');
                else if (originalText.includes('2 days')) $label.text('+2 days');
                else if (originalText.includes('3 days')) $label.text('+3 days');
            } else {
                $label.text(originalText);
            }
        });
    }

    handleResponsiveLayout();
    $(window).on('resize', handleResponsiveLayout);
});
</script>
{% endblock %}