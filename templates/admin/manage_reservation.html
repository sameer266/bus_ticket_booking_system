{% extends 'components/base.html' %}
{% block title %}Vehicle Reservations | Go Sewa{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row g-0">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar collapse" id="sidebarMenu">
            {% include 'components/sidebar.html' %}
        </div>
        <!-- Main Content -->
        <main class="mt-5 col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4 main-content ">

               <!-- Messages --> 
               {% if messages %}
               {% for message in messages %}
                   <div class="alert alert-{{ message.tags }} alert-dismissible fade show mt-2" role="alert">
                       {{ message }}
                       <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                   </div>
               {% endfor %}
           {% endif %}


            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4">
                <h1 class="h2 fw-bold">
                    <i class="bi bi-car-front me-2 text-primary"></i>Vehicle Reservations
                </h1>
                <div class="btn-toolbar d-none d-md-flex">
                    <div class="btn-group me-2">
                        <button id="addReservationBtn" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-plus-lg me-1"></i> Add Vehicle
                        </button>
                        <button id="manageVehicleTypesBtn" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-list-check me-1"></i> Manage Types
                        </button>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm table-container">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-car-front me-2"></i>Vehicle Reservation List
                    </h5>
                    <div class="input-group input-group-sm" style="max-width: 250px;">
                        <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchReservations" placeholder="Search reservations...">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3">Vehicle</th>
                                    <th class="d-none d-md-table-cell">Type</th>
                                    <th class="d-none d-lg-table-cell">Number</th>
                                    <th class="d-none d-xl-table-cell">Model</th>
                                    <th class="text-center">Seats</th>
                                    <th class="d-none d-lg-table-cell">Color</th>
                                    <th class="d-none d-xl-table-cell">Price</th>
                                    <th class="d-none d-xl-table-cell">Driver</th>
                                    <th class="d-none d-xl-table-cell">Staff</th>
                                    <th class="text-end pe-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reservation in reservations %}
                                <tr data-reservation-id="{{ reservation.id }}">
                                    <td class="ps-3">
                                        <div class="d-flex align-items-center gap-2">
                                            {% if reservation.image %}
                                            <img src="{{ reservation.image.url }}" class="rounded" style="width: 40px; height: 40px; object-fit: cover;" alt="{{ reservation.name }}">
                                            {% else %}
                                            <div class="avatar bg-secondary text-white d-flex align-items-center justify-content-center rounded" style="width: 40px; height: 40px;">
                                                <i class="bi bi-car-front"></i>
                                            </div>
                                            {% endif %}
                                            <div class="overflow-hidden">
                                                <h6 class="mb-0 text-truncate">{{ reservation.name }}</h6>
                                                <small class="text-muted d-md-none text-truncate">
                                                    {{ reservation.type.name|default:"-" }} â€¢ {{ reservation.vechicle_number }}
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <span class="badge bg-primary bg-opacity-10 text-primary">
                                            {{ reservation.type.name|default:"-" }}
                                        </span>
                                    </td>
                                    <td class="d-none d-lg-table-cell">{{ reservation.vechicle_number }}</td>
                                    <td class="d-none d-xl-table-cell">{{ reservation.vechicle_model|default:"-" }}</td>
                                    <td class="text-center">{{ reservation.total_seats }}</td>
                                    <td class="d-none d-lg-table-cell">
                                        <span class="badge rounded-pill" style="background-color:gray; ">
                                            {{ reservation.color|default:"N/A" }}
                                        </span>
                                    </td>
                                    <td class="d-none d-xl-table-cell text-nowrap">
                                        {% if reservation.price %}
                                        Rs {{ reservation.price|floatformat:2 }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="d-none d-xl-table-cell">
                                        {% if reservation.driver %}
                                        <span class="badge bg-info bg-opacity-10 text-dark">
                                            {{ reservation.driver.full_name }}
                                        </span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="d-none d-xl-table-cell">
                                        {% if reservation.staff %}
                                        <span class="badge bg-info text-dark">
                                            {{ reservation.staff.full_name }}
                                        </span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td class="text-end pe-3">
                                        <div class="d-flex gap-1 justify-content-end">
                                            <!-- Mobile view buttons -->
                                            <a class="btn btn-outline-primary btn-sm edit-reservation-btn d-md-none" href="{% url 'vehicle_reservation_edit' reservation.id %}" title="Edit">
                                                <i class="bi bi-pencil-square"></i>
                                            </a>
                                            <a class="btn btn-outline-danger btn-sm delete-reservation-btn d-md-none" href="{% url 'delete_vehicle_reservation' reservation.id %}" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                           
                                            <!-- Desktop view buttons -->
                                            <a class="btn btn-outline-primary btn-sm edit-reservation-btn d-none d-md-inline-flex align-items-center" href="{% url 'vehicle_reservation_edit' reservation.id %}">
                                                <i class="bi bi-pencil-square me-md-1"></i><span class="d-none d-lg-inline">Edit</span>
                                            </a>
                                            <a class="btn btn-outline-danger btn-sm delete-reservation-btn d-none d-md-inline-flex align-items-center" href="{% url 'delete_vehicle_reservation' reservation.id %}">
                                                <i class="bi bi-trash me-md-1"></i><span class="d-none d-lg-inline">Delete</span>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center py-5">
                                        <i class="bi bi-car-front display-5 text-muted mb-3"></i>
                                        <h5 class="text-muted">No reservations found</h5>
                                        <button id="emptyAddReservationBtn" class="btn btn-primary mt-2">
                                            <i class="bi bi-plus-circle me-1"></i> Add Reservation
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% if reservations.has_other_pages %}
                <div class="card-footer bg-white">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            {% if reservations.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ reservations.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for i in reservations.paginator.page_range %}
                            {% if reservations.number == i %}
                            <li class="page-item active" aria-current="page">
                                <a class="page-link" href="#">{{ i }}</a>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                            </li>
                            {% endif %}
                            {% endfor %}
                            
                            {% if reservations.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ reservations.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>

<!-- Modals (keep your existing modal code) -->

<!-- Add Reservation Modal -->
<div class="modal fade" id="addReservationModal" tabindex="-1" aria-labelledby="addReservationModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReservationModalLabel"><i class="bi bi-car-front me-2 text-primary"></i>Add New Vehicle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'vehicle_reservation' %}" id="addReservationForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="add_reservation" value="1">
                    <div class="row row-cols-1 row-cols-md-2 g-3">
                        <div class="col-md-6">
                            <label class="form-label">Name*</label>
                            <input type="text" class="form-control" name="name" placeholder="Reservation Name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Type*</label>
                            <select class="form-select" name="type" required>
                                <option value="">-- Select Type --</option>
                                {% for vechicle_type in vechicle_types %}
                                <option value="{{ vechicle_type.id }}">{{ vechicle_type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Vehicle Number*</label>
                            <input type="text" class="form-control" name="vechicle_number" placeholder="BA 1-2345" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vehicle Model</label>
                            <input type="text" class="form-control" name="vechicle_model" placeholder="e.g., Toyota HiAce">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Image</label>
                            <input type="file" class="form-control" name="image" accept="image/*">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Document</label>
                            <input type="file" class="form-control" name="document" accept="image/*">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color</label>
                            <input type="text" class="form-control" name="color" placeholder="e.g., White">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Driver*</label>
                            <select class="form-select" name="driver_id" required>
                                <option value="">-- Select Driver --</option>
                                {% for driver in unassigned_drivers %}
                                <option value="{{ driver.id }}">{{ driver.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Staff</label>
                            <select class="form-select" name="staff_id">
                                <option value="">-- Select Staff --</option>
                                {% for staff in unassigned_staff %}
                                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total Seats*</label>
                            <input type="number" class="form-control" name="total_seats" value="35" min="1" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" name="price" placeholder="e.g., 5000" step="0.01">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="addReservationForm" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-1"></i> Add Reservation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Reservation Modal -->
<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editReservationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReservationModalLabel"><i class="bi bi-car-front me-2 text-primary"></i>Edit Reservation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="" id="editReservationForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="reservation_id" id="edit_reservation_id">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Name*</label>
                            <input type="text" class="form-control" name="name" id="edit_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Type*</label>
                            <select class="form-select" name="type" id="edit_type" required>
                                <option value="">-- Select Type --</option>
                                {% for vechicle_type in vechicle_types %}
                                <option value="{{ vechicle_type.id }}">{{ vechicle_type.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vehicle Number*</label>
                            <input type="text" class="form-control" name="vechicle_number" id="edit_vehicle_number" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Vehicle Model</label>
                            <input type="text" class="form-control" name="vechicle_model" id="edit_vehicle_model">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Image</label>
                            <input type="file" class="form-control" name="image" id="edit_image" accept="image/*">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Document</label>
                            <input type="file" class="form-control" name="document" id="edit_document" accept="image/*">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color</label>
                            <input type="text" class="form-control" name="color" id="edit_color">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Driver*</label>
                            <select class="form-select" name="driver_id" id="edit_driver_id" required>
                                <option value="">-- Select Driver --</option>
                                {% for driver in unassigned_drivers %}
                                <option value="{{ driver.id }}">{{ driver.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Staff</label>
                            <select class="form-select" name="staff_id" id="edit_staff_id">
                                <option value="">-- Select Staff --</option>
                                {% for staff in unassigned_staff %}
                                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total Seats*</label>
                            <input type="number" class="form-control" name="total_seats" id="edit_total_seats" min="1" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" name="price" id="edit_price" step="0.01">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="editReservationForm" class="btn btn-warning">
                    <i class="bi bi-pencil-square me-1"></i> Update Reservation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this reservation? This action cannot be undone.</p>
                <p class="fw-bold" id="deleteReservationName"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteReservationForm" action="">
                    {% csrf_token %}
                    <input type="hidden" name="delete_reservation" value="1">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i> Delete Reservation
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Vehicle Types Modal -->

<!-- Vehicle Types Modal -->
<div class="modal fade" id="vehicleTypesModal" tabindex="-1" aria-labelledby="vehicleTypesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vehicleTypesModalLabel"><i class="bi bi-list-check me-2 text-primary"></i>Manage Vehicle Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Current Types List -->
                <div class="mb-3">
                    <h6 class="fw-bold mb-2">Current Vehicle Types</h6>
                    <div class="list-group mb-3">
                        {% for vechicle_type in vechicle_types %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            {{ vechicle_type.name }}
                            <button class="btn btn-sm btn-outline-danger delete-type-btn" data-type-id="{{ vechicle_type.id }}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-center text-muted">No vehicle types defined</div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Add New Type Form -->
                <form method="POST" action="{% url 'create_vehicle_type' %}" id="addTypeForm">
                    {% csrf_token %}
                    <h6 class="fw-bold mb-2">Add New Type</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" name="type_name" placeholder="Type name" required>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-plus-lg"></i> Add
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


{% block extra_css %}
<style>

    .sidebar {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        background-color: #fff;
        transition: all 0.3s;
    }
    .main-content {
        background-color: #f8f9fa;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    .badge {
        font-weight: 500;
        padding: 0.35em 0.5em;
    }
    .avatar {
        font-size: 1.2rem;
    }
    @media (max-width: 767.98px) {
        .table-container {
            margin-left: 0;
        }
        .sidebar {
            position: static;
            height: auto;
        }
    }
    @media (max-width: 1199.98px) {
        .table td, .table th {
            white-space: nowrap;
        }
    }
</style>
{% endblock %}



{% block extra_js %}
<script>

    // Add this to your existing 'DOMContentLoaded' event handler
document.querySelectorAll('.delete-reservation-btn').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Get the reservation ID and name
        const row = this.closest('tr');
        const reservationId = row.dataset.reservationId;
        const reservationName = row.querySelector('h6').textContent;
        
        // Update the delete confirmation modal
        document.getElementById('deleteReservationName').textContent = reservationName;
        document.getElementById('deleteReservationForm').action = this.href;
        
        // Show the delete confirmation modal
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        deleteConfirmModal.show();
    });
});

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap modals with explicit backdrop option
        const addReservationModalElement = document.getElementById('addReservationModal');
        const editReservationModalElement = document.getElementById('editReservationModal');
        const deleteConfirmModalElement = document.getElementById('deleteConfirmModal');

        const addReservationModal = new bootstrap.Modal(addReservationModalElement, { backdrop: true });
        const editReservationModal = new bootstrap.Modal(editReservationModalElement, { backdrop: true });
        const deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalElement, { backdrop: true });

        // Ensure backdrop is removed and body styles are reset when modals are hidden
        [addReservationModalElement, editReservationModalElement, deleteConfirmModalElement].forEach(modal => {
            modal.addEventListener('hidden.bs.modal', function () {
                // Forcefully remove any lingering backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                // Reset body classes and styles to restore interactivity
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            });
        });

        // Show Add Reservation Modal
        const addButtons = [
            document.getElementById('addReservationBtn'),

            document.getElementById('emptyAddReservationBtn')
        ];
        addButtons.forEach(button => {
            if (button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent any default behavior
                    addReservationModal.show();
                });
            }
        });



        // Search functionality
        document.getElementById('searchReservations').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr:not([data-reservation-id=""])');
            rows.forEach(row => {
                const name = row.querySelector('h6')?.textContent.toLowerCase() || '';
                row.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        });
    });

    // Vehicle Types Modal

    // Add this to your existing JavaScript in the DOMContentLoaded event
const vehicleTypesModalElement = document.getElementById('vehicleTypesModal');
const vehicleTypesModal = new bootstrap.Modal(vehicleTypesModalElement, { backdrop: true });

// Reset modal when hidden like others
vehicleTypesModalElement.addEventListener('hidden.bs.modal', function () {
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
});

// Redirect to vehicle types page instead of showing modal
document.getElementById('manageVehicleTypesBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    window.location.href = "{% url 'vehicle_type_list' %}";
});

document.getElementById('mobileManageTypesBtn')?.addEventListener('click', function(e) {
    e.preventDefault();
    window.location.href = "{% url 'vehicle_type_list' %}";
});

// Handle delete type button with form submission instead of fetch
document.querySelectorAll('.delete-type-btn').forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        const typeId = this.dataset.typeId;
        if (confirm('Are you sure you want to delete this vehicle type?')) {
            // Create and submit a form to delete the vehicle type
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `vehicle-type-delete/${typeId}/`;
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            const deleteInput = document.createElement('input');
            deleteInput.type = 'hidden';
            deleteInput.name = 'delete_type';
            deleteInput.value = '1';
            
            form.appendChild(csrfInput);
            form.appendChild(deleteInput);
            document.body.appendChild(form);
            form.submit();
        }
    });
}


);

</script>
{% endblock %}
{% endblock %}