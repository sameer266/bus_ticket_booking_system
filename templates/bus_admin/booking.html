{% extends 'components/base.html' %}

{% block title %}
    Seat Bookings | Go Sewa
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Add CSRF token in a hidden form for AJAX requests -->
    <form id="csrf-form" style="display: none;">
        {% csrf_token %}
    </form>
    <div class="row g-0">
        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 ms-md-auto px-md-4 py-4 main-content">
            <h1 class="h2 mb-4 fw-bold text-primary"><i class="bi bi-ticket me-2"></i>Seat Bookings</h1>

            <!-- Error and Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-4" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- Filter and Search Section -->
            <div class="card shadow-sm mb-4 modern-card bg-light">
                <div class="card-header bg-white">
                    <h3 class="h5 mb-0 fw-bold text-primary"><i class="bi bi-funnel me-2"></i>Filters & Search</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-start-0" id="global-search" placeholder="Search by customer, trip, or booking ID..." aria-label="Search seat bookings">
                                <button class="btn btn-outline-secondary" type="button" id="clear-search" aria-label="Clear search"><i class="bi bi-x-circle"></i></button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <select class="form-select" id="status-filter" aria-label="Filter by status">
                                        <option value="">All Statuses</option>
                                        <option value="booked">Booked</option>
                                        <option value="pending">Pending</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="start-date" aria-label="Start date">
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="end-date" aria-label="End date">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" id="today-filter" aria-label="Filter by today"><i class="bi bi-calendar-day me-1"></i> Today</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seat Bookings Table (Directly Displayed) -->
            <div class="card shadow-sm modern-card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h3 class="h5 mb-0 fw-bold text-primary"><i class="bi bi-ticket me-2"></i>Seat Bookings</h3>
                    <div class="text-muted small">
                        Showing <span id="booking-showing-count">{{ booking_data|length }}</span> of {{ booking_data.paginator.count }} records
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-modern mb-0" id="bookings-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Customer</th>
                                    <th>Trip</th>
                                    <th>Seats</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Payment Status</th>
                                    {% if user.role == 'bus_admin' %}
                                    <th>Action</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in booking_data %}
                                    <tr class="booking-row" 
                                        data-status="{{ booking.booking_status|lower }}"
                                        data-booked-date="{{ booking.booked_at|date:'Y-m-d' }}"
                                        data-search="#{{ booking.id }} {{ booking.user.full_name|lower }} {{ booking.schedule.route.source|lower }} {{ booking.schedule.route.destination|lower }}"
                                        data-booking-id="{{ booking.id }}"
                                        data-customer="{{ booking.user.full_name }}"
                                        data-trip="{{ booking.schedule.route.source }} to {{ booking.schedule.route.destination }}">
                                        <td>#{{ booking.id }}</td>
                                        <td>{{ booking.user.full_name|default:'N/A' }}</td>
                                        <td>{{ booking.schedule.route.source|default:'N/A' }} to {{ booking.schedule.route.destination|default:'N/A' }}</td>
                                        <td>{{ booking.seat|join:", "|default:'N/A' }}</td>
                                        <td>
                                            <span class="badge {% if booking.booking_status == 'booked' %}bg-success{% elif booking.booking_status == 'pending' %}bg-warning{% elif booking.booking_status == 'cancelled' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                {{ booking.booking_status|title }}
                                            </span>
                                        </td>
                                        <td>{{ booking.booked_at|date:"d M, Y"|default:'N/A' }}</td>
                                        <td>Rs {{ booking.schedule.price|floatformat:2|default:'0.00' }}</td>
                                        <td>
                                            {% for payment in booking.payments.all %}
                                                <span class="badge 
                                                    {% if payment.payment_status == 'completed' %}bg-success
                                                    {% elif payment.payment_status == 'pending' %}bg-warning
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ payment.payment_status|title }}
                                                </span>
                                            {% empty %}
                                                <span class="badge bg-secondary">No Payment</span>
                                            {% endfor %}
                                        </td>
                                        {% if user.role == 'bus_admin' %}   
                                        <td class="text-end pe-3">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-warning edit-booking-status-btn" 
                                                        data-update-url="{% url 'update_booking_status' booking.id %}"
                                                        data-booking-id="{{ booking.id }}"
                                                        data-current-status="{{ booking.booking_status|lower }}"
                                                        title="Edit Status" aria-label="Edit booking status">
                                                    <i class="bi bi-pencil-square"></i>
                                                </button>
                                                <button class="btn btn-outline-danger delete-booking-btn" 
                                                        data-delete-url="{% url 'delete_booking' booking.id %}"
                                                        title="Delete" aria-label="Delete booking">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                        {% endif %}

                                    </tr>
                                {% empty %}
                                    <tr class="no-results-row">
                                        <td colspan="9" class="text-center py-3">No bookings found</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% if booking_data.paginator.num_pages > 1 %}
                <div class="card-footer bg-white">
                    <nav aria-label="Bookings pagination">
                        <ul class="pagination justify-content-center mb-0">
                            {% if booking_data.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?booking_page={{ booking_data.previous_page_number }}&search={{ request.GET.search|default:'' }}&status={{ request.GET.status|default:'' }}&start_date={{ request.GET.start_date|default:'' }}&end_date={{ request.GET.end_date|default:'' }}" aria-label="Previous">
                                        <span aria-hidden="true">«</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">«</span>
                                </li>
                            {% endif %}
                            {% for num in booking_data.paginator.page_range %}
                                {% if booking_data.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > booking_data.number|add:'-3' and num < booking_data.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?booking_page={{ num }}&search={{ request.GET.search|default:'' }}&status={{ request.GET.status|default:'' }}&start_date={{ request.GET.start_date|default:'' }}&end_date={{ request.GET.end_date|default:'' }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            {% if booking_data.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?booking_page={{ booking_data.next_page_number }}&search={{ request.GET.search|default:'' }}&status={{ request.GET.status|default:'' }}&start_date={{ request.GET.start_date|default:'' }}&end_date={{ request.GET.end_date|default:'' }}" aria-label="Next">
                                        <span aria-hidden="true">»</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">»</span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-12">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i>Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this booking?</p>
                <div class="alert alert-light border p-3 mt-2">
                    <p class="mb-1 fw-bold" id="deleteDetails"></p>
                </div>
                <p class="text-muted mt-3">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash me-1"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-12">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="updateStatusModalLabel"><i class="bi bi-pencil-square me-2"></i>Update Booking Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Update the status for Booking ID: <strong id="updateBookingId"></strong></p>
                <div class="alert alert-light border p-3 mt-2">
                    <p class="mb-1 fw-bold" id="updateDetails"></p>
                </div>
                <div class="mb-3">
                    <label for="new-status" class="form-label">New Status</label>
                    <select class="form-select" id="new-status" aria-label="Select new status">
                        <option value="booked">Booked</option>
                        <option value="pending">Pending</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmUpdateStatusBtn">
                    <i class="bi bi-check-circle me-1"></i> Update
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .main-content {
       
        width: calc(100% - 260px);
        transition: margin-left 0.3s;
    }
    @media (max-width: 991.98px) {
        .main-content {
            margin-left: 0;
            width: 100%;
        }
    }

    .modern-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .modern-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15) !important;
    }
    .table-modern th {
        background-color: #f8f9fa;
        color: #343a40;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    .table-modern tbody tr {
        transition: background-color 0.3s ease;
    }
    .table-modern tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    .table-modern td {
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }
    .badge {
        font-weight: 500;
        text-transform: capitalize;
        padding: 0.4em 0.8em;
    }
    .input-group-text {
        background-color: #f8f9fa;
    }
    .hidden-row {
        display: none !important;
    }
    .modal-content {
        border-radius: 12px;
    }
    .modal-header {
        border-bottom: none;
    }
    .modal-footer {
        border-top: none;
    }
    .btn:focus, .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1060;
    }
    .rounded-12 {
        border-radius: 12px !important;
    }

    @media (max-width: 767.98px) {
        .table td, .table th {
            font-size: 0.875rem;
        }
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
        }
    }
    @media (max-width: 575.98px) {
        .card-body {
            padding: 1rem;
        }
        .btn-group-sm .btn {
            font-size: 0.75rem;
        }
    }
    .modal { z-index: 1055; }
    .modal-backdrop { z-index: 1050; }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Bootstrap components
    const deleteModal = new bootstrap.Modal('#deleteConfirmModal', { keyboard: false });
    const updateStatusModal = new bootstrap.Modal('#updateStatusModal', { keyboard: false });

    // Toast notification utility
    function showToast(message, type = 'success') {
        let $toastContainer = $('.toast-container');
        if (!$toastContainer.length) {
            $toastContainer = $('<div class="toast-container"></div>').appendTo('body');
        }

        const $toast = $(`
            <div class="toast align-items-center text-white bg-${type} border-0 rounded-4" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `).appendTo($toastContainer);

        const toast = new bootstrap.Toast($toast[0], { delay: 5000 });
        toast.show();
        $toast.on('hidden.bs.toast', () => $toast.remove());
    }

    // Show Django messages
    {% if messages %}
    {% for message in messages %}
    showToast('{{ message|escapejs }}', '{{ message.tags|escapejs }}');
    {% endfor %}
    {% endif %}

    // Filter tables
    function filterTables() {
        const searchTerm = $('#global-search').val().toLowerCase().trim();
        const statusValue = $('#status-filter').val().toLowerCase();
        const startDateValue = $('#start-date').val();
        const endDateValue = $('#end-date').val();

        let visibleBookingRows = 0;
        $('#bookings-table tbody tr.booking-row').each(function() {
            const $row = $(this);
            const searchText = $row.data('search').toLowerCase();
            const status = $row.data('status');
            const rowDate = $row.data('booked-date');

            const matchesSearch = !searchTerm || searchText.includes(searchTerm);
            const matchesStatus = !statusValue || status === statusValue;
            const matchesDate = (!startDateValue || !rowDate || rowDate >= startDateValue) && 
                              (!endDateValue || !rowDate || rowDate <= endDateValue);

            $row.toggleClass('hidden-row', !(matchesSearch && matchesStatus && matchesDate));
            if (matchesSearch && matchesStatus && matchesDate) visibleBookingRows++;
        });

        $('#booking-showing-count').text(visibleBookingRows || 0);

        updateNoResultsRow('#bookings-table', visibleBookingRows, 9);
    }

    // Update no results row
    function updateNoResultsRow(tableId, visibleCount, colspan) {
        const $table = $(tableId);
        let $noResultsRow = $table.find('tbody tr.no-results-row');

        if (visibleCount === 0) {
            if (!$noResultsRow.length || !$noResultsRow.text().includes('No matching')) {
                $noResultsRow.remove();
                $table.find('tbody').append(
                    `<tr class="no-results-row"><td colspan="${colspan}" class="text-center py-3">No matching records found</td></tr>`
                );
            }
        } else {
            $noResultsRow.remove();
        }
    }

    // Event handlers
    $('#global-search, #status-filter, #start-date, #end-date').on('input change', filterTables);

    $('#clear-search').on('click', function() {
        $('#global-search, #status-filter, #start-date, #end-date').val('');
        filterTables();
    });

    $('#today-filter').on('click', function() {
        const today = new Date().toISOString().split('T')[0];
        $('#start-date, #end-date').val(today);
        filterTables();
    });

    // Delete confirmation
    let currentDeleteUrl = '';
    $(document).on('click', '.delete-booking-btn', function() {
        const $btn = $(this);
        currentDeleteUrl = $btn.data('delete-url');
        
        const $row = $btn.closest('tr');
        const details = `Booking ID: #${$row.data('booking-id')}<br>Customer: ${$row.data('customer')}<br>Trip: ${$row.data('trip')}`;

        $('#deleteDetails').html(details);
        deleteModal.show();
    });

    $('#confirmDeleteBtn').on('click', function() {
        if (currentDeleteUrl) {
            $.ajax({
                url: currentDeleteUrl,
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: $('#csrf-form input[name="csrfmiddlewaretoken"]').val()
                },
                success: function(response) {
                    showToast('Booking deleted successfully', 'success');
                    deleteModal.hide();
                    setTimeout(() => window.location.reload(), 1000);
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.error || 'Failed to delete booking';
                    showToast(errorMsg, 'danger');
                }
            });
        }
    });

    // Update status
    let currentUpdateUrl = '';
    $(document).on('click', '.edit-booking-status-btn', function(e) {
        e.preventDefault();
        const $btn = $(this);
        currentUpdateUrl = $btn.data('update-url');
        const bookingId = $btn.data('booking-id');
        const currentStatus = $btn.data('current-status');
        
        const $row = $btn.closest('tr');
        const details = `Booking ID: #${$row.data('booking-id')}<br>Customer: ${$row.data('customer')}<br>Trip: ${$row.data('trip')}`;
        
        $('#updateBookingId').text(`#${bookingId}`);
        $('#updateDetails').html(details);
        $('#new-status').val(currentStatus);
        updateStatusModal.show();
    });

    $('#confirmUpdateStatusBtn').on('click', function() {
        if (currentUpdateUrl) {
            const newStatus = $('#new-status').val();
            $.ajax({
                url: currentUpdateUrl,
                type: 'POST',
                data: {
                    status: newStatus,
                    csrfmiddlewaretoken: $('#csrf-form input[name="csrfmiddlewaretoken"]').val()
                },
                success: function(response) {
                    showToast('Booking status updated successfully', 'success');
                    updateStatusModal.hide();
                    setTimeout(() => window.location.reload(), 1000);
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.error || 'Failed to update status';
                    showToast(errorMsg, 'danger');
                }
            });
        }
    });

    // Responsive layout
    function handleResponsiveLayout() {
        const isMobile = window.innerWidth < 576;
        $('.btn-group-sm .btn').each(function() {
            const $btn = $(this);
            $btn.find('.bi').toggleClass('d-none', !isMobile);
            $btn.find('span').toggleClass('d-none', isMobile);
        });
    }

    handleResponsiveLayout();
    $(window).on('resize', handleResponsiveLayout);

    // Initialize filters
    filterTables();
});
</script>
{% endblock %}